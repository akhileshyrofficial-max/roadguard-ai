import{e as Me}from"./common-DQOJ18NT.js";import{b1 as me,$ as Se,B as Z,A as we,az as Ee,aA as Le,aB as J,a7 as be,aC as Be,x as Ae,u as Re,aN as Ce,fz as Te,c as A,m as $,d as $e,b3 as K,ee as Pe,cv as Fe,fA as ze}from"./Identifiable-_3rFZ1o6.js";import{e as X}from"./TileKey-upwcIO5W.js";import{m as Ne,b as Q}from"./vec2-ChnYg_BJ.js";import{s as Oe}from"./Queue-CJjQn74K.js";import{s as D}from"./ReactiveMap-DptZZMoQ.js";import{r as Ye}from"./signal-R7pX2aet.js";import{t as Xe}from"./quickselect-QQC62dOK.js";import{b as ke}from"./Query-Dp8boimB.js";function qe(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t}function Ve(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t}function De(t,e,s,i,r,o,n){return t[0]=e,t[1]=s,t[2]=i,t[3]=r,t[4]=o,t[5]=n,t}function He(t,e){const s=e[0],i=e[1],r=e[2],o=e[3],n=e[4],l=e[5];let h=s*o-i*r;return h?(h=1/h,t[0]=o*h,t[1]=-i*h,t[2]=-r*h,t[3]=s*h,t[4]=(r*l-o*n)*h,t[5]=(i*n-s*l)*h,t):null}function Ue(t){return t[0]*t[3]-t[1]*t[2]}function _e(t,e,s){const i=e[0],r=e[1],o=e[2],n=e[3],l=e[4],h=e[5],a=s[0],c=s[1],u=s[2],f=s[3],_=s[4],p=s[5];return t[0]=i*a+o*c,t[1]=r*a+n*c,t[2]=i*u+o*f,t[3]=r*u+n*f,t[4]=i*_+o*p+l,t[5]=r*_+n*p+h,t}function je(t,e,s){const i=e[0],r=e[1],o=e[2],n=e[3],l=e[4],h=e[5],a=Math.sin(s),c=Math.cos(s);return t[0]=i*c+o*a,t[1]=r*c+n*a,t[2]=i*-a+o*c,t[3]=r*-a+n*c,t[4]=l,t[5]=h,t}function Ge(t,e,s){const i=e[0],r=e[1],o=e[2],n=e[3],l=e[4],h=e[5],a=s[0],c=s[1];return t[0]=i*a,t[1]=r*a,t[2]=o*c,t[3]=n*c,t[4]=l,t[5]=h,t}function Ke(t,e,s){const i=e[0],r=e[1],o=e[2],n=e[3],l=e[4],h=e[5],a=s[0],c=s[1];return t[0]=i,t[1]=r,t[2]=o,t[3]=n,t[4]=i*a+o*c+l,t[5]=r*a+n*c+h,t}function We(t,e){const s=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=s,t[2]=-s,t[3]=i,t[4]=0,t[5]=0,t}function Ze(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t[4]=0,t[5]=0,t}function Je(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=e[0],t[5]=e[1],t}function Qe(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"}function et(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2+t[4]**2+t[5]**2+1)}function tt(t,e,s){return t[0]=e[0]+s[0],t[1]=e[1]+s[1],t[2]=e[2]+s[2],t[3]=e[3]+s[3],t[4]=e[4]+s[4],t[5]=e[5]+s[5],t}function pe(t,e,s){return t[0]=e[0]-s[0],t[1]=e[1]-s[1],t[2]=e[2]-s[2],t[3]=e[3]-s[3],t[4]=e[4]-s[4],t[5]=e[5]-s[5],t}function st(t,e,s){return t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t[3]=e[3]*s,t[4]=e[4]*s,t[5]=e[5]*s,t}function it(t,e,s,i){return t[0]=e[0]+s[0]*i,t[1]=e[1]+s[1]*i,t[2]=e[2]+s[2]*i,t[3]=e[3]+s[3]*i,t[4]=e[4]+s[4]*i,t[5]=e[5]+s[5]*i,t}function rt(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]}function ot(t,e){const s=t[0],i=t[1],r=t[2],o=t[3],n=t[4],l=t[5],h=e[0],a=e[1],c=e[2],u=e[3],f=e[4],_=e[5],p=Me();return Math.abs(s-h)<=p*Math.max(1,Math.abs(s),Math.abs(h))&&Math.abs(i-a)<=p*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-c)<=p*Math.max(1,Math.abs(r),Math.abs(c))&&Math.abs(o-u)<=p*Math.max(1,Math.abs(o),Math.abs(u))&&Math.abs(n-f)<=p*Math.max(1,Math.abs(n),Math.abs(f))&&Math.abs(l-_)<=p*Math.max(1,Math.abs(l),Math.abs(_))}const nt=_e,lt=pe;Object.freeze(Object.defineProperty({__proto__:null,add:tt,copy:qe,determinant:Ue,equals:ot,exactEquals:rt,frob:et,fromRotation:We,fromScaling:Ze,fromTranslation:Je,identity:Ve,invert:He,mul:nt,multiply:_e,multiplyScalar:st,multiplyScalarAndAdd:it,rotate:je,scale:Ge,set:De,str:Qe,sub:lt,subtract:pe,translate:Ke},Symbol.toStringTag,{value:"Module"}));function ht(){const t=new Float32Array(6);return t[0]=1,t[3]=1,t}function at(t){const e=new Float32Array(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e}function ct(t,e,s,i,r,o){const n=new Float32Array(6);return n[0]=t,n[1]=e,n[2]=s,n[3]=i,n[4]=r,n[5]=o,n}function ge(t,e,s,i){const r=e[i],o=e[i+1];t[i]=s[0]*r+s[2]*o+s[4],t[i+1]=s[1]*r+s[3]*o+s[5]}function ut(t,e,s,i=0,r=0,o=2){const n=r||e.length/o;for(let l=i;l<n;l++)ge(t,e,s,l*o)}Object.freeze(Object.defineProperty({__proto__:null,clone:at,create:ht,fromValues:ct,transform:ge,transformMany:ut},Symbol.toStringTag,{value:"Module"}));function P(t,e){return[t,e]}function R(t,e,s){return t[0]=e,t[1]=s,t}function ft(t,e,s,i,r){return t[0]=e,t[1]=s,t[2]=i,t[3]=r,t}const M=new X("0/0/0/0");let dt=class Ie{static create(e,s,i=null){const r=me(e.spatialReference),o=s.origin||P(e.origin.x,e.origin.y),n=P(e.size[0]*s.resolution,e.size[1]*s.resolution),l=P(-1/0,-1/0),h=P(1/0,1/0),a=P(1/0,1/0);i!=null&&(R(l,Math.max(0,Math.floor((i.xmin-o[0])/n[0])),Math.max(0,Math.floor((o[1]-i.ymax)/n[1]))),R(h,Math.max(0,Math.floor((i.xmax-o[0])/n[0])),Math.max(0,Math.floor((o[1]-i.ymin)/n[1]))),R(a,h[0]-l[0]+1,h[1]-l[1]+1));const{cols:c,rows:u}=s;let f,_,p,g;return!i&&c&&u&&(R(l,c[0],u[0]),R(h,c[1],u[1]),R(a,c[1]-c[0]+1,u[1]-u[0]+1)),e.isWrappable?(f=P(Math.ceil(Math.round((r.valid[1]-r.valid[0])/s.resolution)/e.size[0]),a[1]),_=!0,p=r.origin,g=r.valid):(f=a,_=!1),new Ie(s.level,s.resolution,s.scale,o,l,h,a,n,f,_,p,g)}constructor(e,s,i,r,o,n,l,h,a,c,u,f){this.level=e,this.resolution=s,this.scale=i,this.origin=r,this.first=o,this.last=n,this.size=l,this.norm=h,this.worldSize=a,this.wrap=c,this._spatialReferenceOrigin=u,this._spatialReferenceValid=f}normalizeCol(e){if(!this.wrap)return e;const s=this.worldSize[0];return e<0?s-1-Math.abs((e+1)%s):e%s}normalizeKey(e){if(!this.wrap)return;const s=this.worldSize[0],i=e.col;i<0?(e.col=i+s,e.world-=1):i>=s&&(e.col=i-s,e.world+=1)}denormalizeCol(e,s){return this.wrap?this.worldSize[0]*s+e:e}getWorldForColumn(e){return this.wrap?Math.floor(e/this.worldSize[0]):0}getFirstColumnForWorld(e){return e*this.worldSize[0]+this.first[0]}getLastColumnForWorld(e){return e*this.worldSize[0]+this.first[0]+this.size[0]-1}getColumnForX(e){return(e-this.origin[0])/this.norm[0]}getXForColumn(e){const s=this.origin[0]+e*this.norm[0],i=this._spatialReferenceOrigin,r=this._spatialReferenceValid;return this.wrap&&i&&r?s===i[0]?r[0]:this.origin[0]===i[0]&&e===this.worldSize[0]?r[1]:s:s}getRowForY(e){return(this.origin[1]-e)/this.norm[1]}getYForRow(e){return this.origin[1]-e*this.norm[1]}getTileBounds(e,s,i=!1){M.set(s);const r=i?M.col:this.denormalizeCol(M.col,M.world),o=M.row;return ft(e,this.getXForColumn(r),this.getYForRow(o+1),this.getXForColumn(r+1),this.getYForRow(o)),e}getTileCoords(e,s,i=!1){M.set(s);const r=i?M.col:this.denormalizeCol(M.col,M.world);return Array.isArray(e)?R(e,this.getXForColumn(r),this.getYForRow(M.row)):(e.x=this.getXForColumn(r),e.y=this.getYForRow(M.row)),e}};var T;let ye=(T=class{constructor(){this.spans=[]}acquire(e){this.lodInfo=e}release(){this.lodInfo=null,this.spans.length=0}*keys(){const e=this.lodInfo;for(const{row:s,colFrom:i,colTo:r}of this.spans)for(let o=i;o<=r;o++){const n=e.getWorldForColumn(o);yield new X(e.level,s,e.normalizeCol(o),n)}}forEach(e,s){const{spans:i,lodInfo:r}=this,{level:o}=r;if(i.length!==0)for(const{row:n,colFrom:l,colTo:h}of i)for(let a=l;a<=h;a++)e.call(s,o,n,r.normalizeCol(a),r.getWorldForColumn(a))}},T.pool=new Se(T),T),H=class{constructor(e,s,i){this.row=e,this.colFrom=s,this.colTo=i}};const m=new X("0/0/0/0");let mt=class xe{static create(e,s){e[1]>s[1]&&([e,s]=[s,e]);const[i,r]=e,[o,n]=s,l=o-i,h=n-r,a=h!==0?l/h:0,c=(Math.ceil(r)-r)*a,u=(Math.floor(r)-r)*a;return new xe(i,Math.floor(r),Math.ceil(n),a,l<0?c:u,l<0?u:c,l<0?o:i,l<0?i:o)}constructor(e,s,i,r,o,n,l,h){this.x=e,this.ymin=s,this.ymax=i,this.invM=r,this.leftAdjust=o,this.rightAdjust=n,this.leftBound=l,this.rightBound=h}incrRow(){this.x+=this.invM}getLeftCol(){return Math.max(this.x+this.leftAdjust,this.leftBound)}getRightCol(){return Math.min(this.x+this.rightAdjust,this.rightBound)}};const v=[[0,0],[0,0],[0,0],[0,0]],_t=1e-6;let $t=class{constructor(e,s=null,i=e.lods[0].level,r=e.lods[e.lods.length-1].level){this.tileInfo=e,this.fullExtent=s,this.scales=[],this._infoByScale={},this._infoByLevel={};const o=e.lods.filter(l=>l.level>=i&&l.level<=r);this.minScale=o[0].scale,this.maxScale=o[o.length-1].scale;const n=this._lodInfos=o.map(l=>dt.create(e,l,s));o.forEach((l,h)=>{this._infoByLevel[l.level]=n[h],this._infoByScale[l.scale]=n[h],this.scales[h]=l.scale},this),this._wrap=e.isWrappable}get spatialReference(){return this.tileInfo.spatialReference}getLODInfoAt(e){return this._infoByLevel[typeof e=="number"?e:e.level]}getTileBounds(e,s,i=!1){m.set(s);const r=this._infoByLevel[m.level];return r?r.getTileBounds(e,m,i):e}getTileCoords(e,s,i=!1){m.set(s);const r=this._infoByLevel[m.level];return r?r.getTileCoords(e,m,i):e}getTileCoverage(e,s=192,i=!0,r="closest"){if(!i&&(e.scale>this.minScale||e.scale<this.maxScale))return null;const o=r==="closest"?this.getClosestInfoForScale(e.scale):this.getSmallestInfoForScale(e.scale),n=ye.pool.acquire(o),l=this._wrap;let h,a,c,u=1/0,f=-1/0;const _=n.spans;v[0][0]=v[0][1]=v[1][1]=v[3][0]=-s,v[1][0]=v[2][0]=e.size[0]+s,v[2][1]=v[3][1]=e.size[1]+s;for(const d of v)e.toMap(d,d),d[0]=o.getColumnForX(d[0]),d[1]=o.getRowForY(d[1]);const p=[];let g=3;for(let d=0;d<4;d++){if(v[d][1]===v[g][1]){g=d;continue}const I=mt.create(v[d],v[g]);u=Math.min(I.ymin,u),f=Math.max(I.ymax,f),p[I.ymin]===void 0&&(p[I.ymin]=[]),p[I.ymin].push(I),g=d}if(u==null||f==null||f-u>100)return null;let x=[];for(h=u;h<f;){p[h]!=null&&(x=x.concat(p[h])),a=1/0,c=-1/0;for(let d=x.length-1;d>=0;d--){const I=x[d];a=Math.min(a,I.getLeftCol()),c=Math.max(c,I.getRightCol())}if(a=Math.floor(a),c=Math.floor(c),h>=o.first[1]&&h<=o.last[1])if(l)if(o.size[0]<o.worldSize[0]){const d=Math.floor(c/o.worldSize[0]);for(let I=Math.floor(a/o.worldSize[0]);I<=d;I++)_.push(new H(h,Math.max(o.getFirstColumnForWorld(I),a),Math.min(o.getLastColumnForWorld(I),c)))}else _.push(new H(h,a,c));else a>o.last[0]||c<o.first[0]||(a=Math.max(a,o.first[0]),c=Math.min(c,o.last[0]),_.push(new H(h,a,c)));h+=1;for(let d=x.length-1;d>=0;d--){const I=x[d];I.ymax>=h?I.incrRow():x.splice(d,1)}}return n}getTileParentId(e){m.set(e);const s=this._infoByLevel[m.level],i=this._lodInfos.indexOf(s)-1;return i<0?null:(this._getTileIdAtLOD(m,this._lodInfos[i],m),m.id)}getTileResolution(e){const s=this._infoByLevel[typeof e=="object"?e.level:e];return s?s.resolution:-1}getTileScale(e){const s=this._infoByLevel[e.level];return s?s.scale:-1}intersects(e,s){m.set(s);const i=this._infoByLevel[m.level],r=e.lodInfo;if(r.resolution>i.resolution){this._getTileIdAtLOD(m,r,m);const n=r.denormalizeCol(m.col,m.world);for(const l of e.spans)if(l.row===m.row&&l.colFrom<=n&&l.colTo>=n)return!0}if(r.resolution<i.resolution){const[n,l,h,a]=e.spans.reduce((g,x)=>(g[0]=Math.min(g[0],x.row),g[1]=Math.max(g[1],x.row),g[2]=Math.min(g[2],x.colFrom),g[3]=Math.max(g[3],x.colTo),g),[1/0,-1/0,1/0,-1/0]),c=i.denormalizeCol(m.col,m.world),u=r.getColumnForX(i.getXForColumn(c)),f=r.getRowForY(i.getYForRow(m.row)),_=r.getColumnForX(i.getXForColumn(c+1))-1,p=r.getRowForY(i.getYForRow(m.row+1))-1;return!(u>a||_<h||f>l||p<n)}const o=r.denormalizeCol(m.col,m.world);return e.spans.some(n=>n.row===m.row&&n.colFrom<=o&&n.colTo>=o)}normalizeBounds(e,s,i){if(e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],this._wrap){const r=me(this.tileInfo.spatialReference),o=-i*(r.valid[1]-r.valid[0]);e[0]+=o,e[2]+=o}return e}getSmallestInfoForScale(e){const s=this.scales;if(this._infoByScale[e])return this._infoByScale[e];if(e>s[0])return this._infoByScale[s[0]];for(let i=1;i<s.length-1;i++)if(e>s[i]+_t)return this._infoByScale[s[i-1]];return this._infoByScale[s[s.length-1]]}getClosestInfoForScale(e){const s=this.scales;return this._infoByScale[e]||(e=s.reduce((i,r)=>Math.abs(r-e)<Math.abs(i-e)?r:i,s[0])),this._infoByScale[e]}scaleToLevel(e){const s=this.scales;if(this._infoByScale[e])return this._infoByScale[e].level;for(let i=s.length-1;i>=0;i--)if(e<s[i])return i===s.length-1?this._infoByScale[s[s.length-1]].level:this._infoByScale[s[i]].level+(s[i]-e)/(s[i]-s[i+1]);return this._infoByScale[s[0]].level}scaleToZoom(e){return this.tileInfo.scaleToZoom(e)}zoomToScale(e){return this.tileInfo.zoomToScale(e)}_getTileIdAtLOD(e,s,i){const r=this._infoByLevel[i.level];return e.set(i),s.resolution<r.resolution?null:(s.resolution===r.resolution||(e.level=s.level,e.col=Math.floor(i.col*r.resolution/s.resolution+.01),e.row=Math.floor(i.row*r.resolution/s.resolution+.01)),e)}},pt=class{constructor(e,s){this.item=e,this.controller=s,this.promise=null}},gt=class{constructor(e){this._schedule=null,this._task=null,this._deferreds=new D,this._controllers=new D,this._processingItems=new D,this._pausedSignal=Ye(!1),this.concurrency=1,e.concurrency&&(this.concurrency=e.concurrency),this._queue=new Oe(e.peeker),this.process=e.process;const s=e.scheduler;e.priority&&s&&(this._task=s.registerTask(e.priority,this))}destroy(){this.clear(),this._schedule=Z(this._schedule),this._task=Z(this._task)}get updating(){var e;return!!((e=this._task)!=null&&e.updating)||this.running}get length(){return this._processingItems.size+this._queue.length}abort(e){const s=this._controllers.get(e);s&&s.abort()}clear(){this._queue.clear();const e=[];this._controllers.forEach(s=>e.push(s)),this._controllers.clear(),e.forEach(s=>s.abort()),this._processingItems.clear(),this._cancelNext()}forEach(e){this._deferreds.forEach((s,i)=>e(i))}get(e){const s=this._deferreds.get(e);return s?s.promise:void 0}isOngoing(e){return this._processingItems.has(e)}has(e){return this._deferreds.has(e)}pause(){this._pausedSignal.value||(this._pausedSignal.value=!0,this._cancelNext())}push(e,s){const i=this.get(e);if(i)return i;const r=new AbortController;let o=null;s&&(o=we(s,()=>r.abort()));const n=()=>{const c=this._processingItems.get(e);c&&c.controller.abort(),l(),a.reject(J())},l=()=>{h.remove(),o!=null&&o.remove(),this._removeItem(e),this._queue.remove(e),this._scheduleNext()},h=Ee(r.signal,n),a=Le();return this._deferreds.set(e,a),this._controllers.set(e,r),a.promise.then(l,l),this._queue.push(e),this._scheduleNext(),a.promise}last(){return this._queue.last()}lastPromise(){const e=this.last();return e?this.get(e):null}peek(){return this._queue.peek()}popLast(){var s;const e=this._queue.popLast();return e&&((s=this._deferreds.get(e))==null||s.reject(J()),this._removeItem(e)),e}reset(){const e=Array.from(this._processingItems.values());this._processingItems.clear();for(const s of e)this._queue.push(s.item),s.controller.abort();this._scheduleNext()}resume(){this._pausedSignal.value&&(this._pausedSignal.value=!1,this._scheduleNext())}takeAll(){const e=[];for(;this._queue.length;)e.push(this._queue.pop());return this.clear(),e}get running(){return!this._pausedSignal.value&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(e){for(;!e.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),e.madeProgress()}_removeItem(e){this._deferreds.delete(e),this._controllers.delete(e),this._processingItems.delete(e)}_scheduleNext(){this._task||this._pausedSignal.value||this._schedule||(this._schedule=be(()=>{this._schedule=null,this._next()}))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(e,s){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).resolve(s))}_processError(e,s){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).reject(s))}_canProcessFulfillment(e){return!!this._deferreds.get(e.item)&&this._processingItems.get(e.item)===e}_process(e){if(e==null)return;let s;const i=new AbortController,r=new pt(e,i);this._processingItems.set(e,r);try{s=this.process(e,i.signal)}catch(o){this._processError(r,o)}Be(s)?(r.promise=s,s.then(o=>this._processResult(r,o),o=>this._processError(r,o))):this._processResult(r,s)}get test(){}};const ee=[0,0];let L=class extends Ae{constructor(e){super(e),this._keyToItem=new Map,this._tilesByScale=new Map,this.concurrency=6}initialize(){const{concurrency:e,process:s,scheduler:i,priority:r}=this;this._queue=new gt({concurrency:e,scheduler:i,priority:r,process:(o,n)=>{const l=this._keyToItem.get(o);return s(l,{signal:n})},peeker:o=>this._peek(o)})}destroy(){this.clear(),this._queue=Re(this._queue)}get length(){return this._queue?this._queue.length:0}abort(e){const s=typeof e=="string"?e:e.id;this._queue.abort(s)}clear(){this._queue.clear(),this._keyToItem.clear(),this._tilesByScale.clear()}has(e){return typeof e=="string"?this._keyToItem.has(e):this._keyToItem.has(e.id)}pause(){this._queue.pause()}push(e){const s=e.key.id;if(this._queue.has(s))return this._queue.get(s);const i=this._queue.push(s),r=this.tileInfoView.getTileScale(e.key),o=Ce(this._tilesByScale,r,()=>new Set),n=()=>{o.delete(e.key),o.size===0&&this._tilesByScale.delete(r),this._keyToItem.delete(s)};return o.add(e.key),this._keyToItem.set(s,e),i.then(n,n),i}reset(){this._queue.reset()}resume(){this._queue.resume()}_peek(e){if(!this.state)return e.values().next().value;const s=new Set;for(const n of e)s.add(this._keyToItem.get(n).key);const i=this.state.scale;let r,o=Number.POSITIVE_INFINITY;for(const[n,l]of this._tilesByScale)if(Te(l,h=>s.has(h))){const h=Math.abs(n-i);h<o&&(r=l,o=h)}return this._getClosestTileKey(r,e).id}_getClosestTileKey(e,s){const i=this.tileInfoView,r=this.state.center;let o,n=Number.POSITIVE_INFINITY;for(const l of e)if(s.has(l.id)){i.getTileCoords(ee,l);const h=Ne(ee,r);h<n&&(n=h,o=l)}return o}};A([$({constructOnly:!0})],L.prototype,"concurrency",void 0),A([$({constructOnly:!0})],L.prototype,"priority",void 0),A([$({constructOnly:!0})],L.prototype,"process",void 0),A([$({constructOnly:!0})],L.prototype,"scheduler",void 0),A([$()],L.prototype,"state",void 0),A([$({constructOnly:!0})],L.prototype,"tileInfoView",void 0),L=A([$e("esri.views.2d.tiling.TileQueue")],L);const Ot=L;class It{constructor(e,s,i){this.maxSize=e,this._tileInfoView=s,this._removedFunc=i,this._tilePerId=new Map,this._tileKeysPerLevel=[]}clear(){this._tilePerId.clear(),this._tileKeysPerLevel=[]}has(e){return this._tilePerId.has(e)}get(e){return this._tilePerId.get(e)}pop(e){const s=this._tilePerId.get(e);if(!s)return;const i=s.key.level,r=this._tileKeysPerLevel[i];te(this._tilePerId,e);for(let o=0;o<r.length;o++)if(r[o].id===e){r.splice(o,1);break}return s.visible=!0,s}add(e){e.visible=!1;const s=e.key,i=s.id;if(this._tilePerId.has(i))return;this._tilePerId.set(i,e);const r=s.level;this._tileKeysPerLevel[r]||(this._tileKeysPerLevel[r]=[]),this._tileKeysPerLevel[r].push(s)}prune(e,s,i){let r=this._tilePerId.size;if(r<=this.maxSize)return;let o=this._tileKeysPerLevel.length-1;for(;r>this.maxSize&&o>=0;)o!==e&&(r=this._pruneAroundCenterTile(r,s,i,o)),o--;r>this.maxSize&&(r=this._pruneAroundCenterTile(r,s,i,e))}_pruneAroundCenterTile(e,s,i,r){const o=this._tileKeysPerLevel[r];if(!o||o.length===0)return e;const{size:n,origin:l}=this._tileInfoView.tileInfo,h=i*n[0],a=i*n[1],c=[0,0],u=[0,0];for(o.sort((f,_)=>(c[0]=l.x+h*(f.col+.5),c[1]=l.y-a*(f.row+.5),u[0]=l.x+h*(_.col+.5),u[1]=l.y-a*(_.row+.5),Q(c,s)-Q(u,s)));o.length>0;){const f=o.pop();if(this._removeTile(f.id),--e===this.maxSize)break}return e}_removeTile(e){const s=this._tilePerId.get(e);this._removedFunc&&s&&this._removedFunc(s),te(this._tilePerId,e)}}function te(t,e){t.delete(e)}const C=new X(0,0,0,0),E=new Map,N=[],U=[];let Yt=class{constructor(e){this._previousScale=Number.POSITIVE_INFINITY,this.cachePolicy="keep",this.coveragePolicy="closest",this.resampling=!0,this.tileIndex=new Map,this.tiles=[],this.buffer=192,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,e.resampling!=null&&(this.resampling=e.resampling),e.cachePolicy&&(this.cachePolicy=e.cachePolicy),e.coveragePolicy&&(this.coveragePolicy=e.coveragePolicy),e.buffer!=null&&(this.buffer=e.buffer),e.cacheSize&&(this._tileCache=new It(e.cacheSize,this.tileInfoView,s=>{this.releaseTile(s)}))}destroy(){this.tileIndex.clear()}update(e){var d,I;const{resampling:s,tileIndex:i}=this,{scale:r,center:o,resolution:n}=e.state,{minScale:l,maxScale:h}=this.tileInfoView,a=!e.stationary&&r>this._previousScale;if(this._previousScale=r,!s&&(r>l||r<h))return this.tiles.length=0,void this.clear();const c=this.tileInfoView.getTileCoverage(e.state,this.buffer,this.resampling,this.coveragePolicy);if(!c)return this.tiles.length=0,void this.clear();const{spans:u,lodInfo:f}=c,{level:_}=f;this.tiles.length=0,i.forEach(y=>y.visible=!0);let p=0,g=0;if(u.length>0)for(const{row:y,colFrom:B,colTo:k}of u)for(let b=B;b<=k;b++){p++;const S=C.set(_,y,f.normalizeCol(b),f.getWorldForColumn(b)).id;let w=i.get(S);if(w)w.isReady?(E.set(S,w),g++):a||this._addParentTile(S,E);else{if((d=this._tileCache)!=null&&d.has(S)){if(w=this._tileCache.pop(S),this.tileIndex.set(S,w),w.isReady){E.set(S,w),g++;continue}}else w=this.acquireTile(C),this.tileIndex.set(S,w);a||this._addParentTile(S,E)}}const x=g===p;for(const[y,B]of i){if(E.has(y))continue;C.set(y);const k=this.tileInfoView.intersects(c,C),b=this.cachePolicy==="purge"?C.level!==_:C.level>_;!k||!a&&x?!b&&k||N.push(B):B.isReady?b&&this.cachePolicy==="purge"&&this._hasReadyAncestor(C,_)?N.push(B):U.push(B):b&&N.push(B)}for(const y of U)y.isReady&&E.set(y.key.id,y);for(const y of N)this._tileCache?this._tileCache.add(y):this.releaseTile(y),i.delete(y.key.id);for(const y of E.values())this.tiles.push(y);for(const y of i.values())E.has(y.key.id)||(y.visible=!1);(I=this._tileCache)==null||I.prune(_,o,n),ye.pool.release(c),U.length=0,N.length=0,E.clear()}clear(){const{tileIndex:e}=this;for(const s of e.values())this.releaseTile(s);e.clear()}refresh(e){var s;for(const i of this.tileIndex.values())e(i);(s=this._tileCache)==null||s.clear()}updateCacheSize(e){this._tileCache&&(this._tileCache.maxSize=e)}_addParentTile(e,s){var o;let i=e,r=null;for(;i=this.tileInfoView.getTileParentId(i),i;)if(this.tileIndex.has(i)){if(r=this.tileIndex.get(i),r==null?void 0:r.isReady){s.has(r.key.id)||s.set(r.key.id,r);break}}else if((o=this._tileCache)!=null&&o.has(i)&&(r=this._tileCache.pop(i),this.tileIndex.set(i,r),r==null?void 0:r.isReady)){s.has(r.key.id)||s.set(r.key.id,r);break}}_hasReadyAncestor(e,s){const i=K();this.tileInfoView.getTileBounds(i,e,!0);for(const r of this.tileIndex.values())if(r.isReady&&r.key.level>=s&&r.key.level<e.level){const o=K();if(this.tileInfoView.getTileBounds(o,r.key,!0),Pe(o,i))return!0}return!1}};function W(t,e){if(!(this instanceof W))return new W(t,e);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&(typeof e=="function"?this.toBBox=e:this._initFormat(e)),this.clear()}function yt(t,e,s){if(!s)return e.indexOf(t);for(var i=0;i<e.length;i++)if(s(t,e[i]))return i;return-1}function F(t,e){O(t,0,t.children.length,e,t)}function O(t,e,s,i,r){r||(r=z(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(var o,n=e;n<s;n++)o=t.children[n],Y(r,t.leaf?i(o):o);return r}function Y(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function se(t,e){return t.minX-e.minX}function ie(t,e){return t.minY-e.minY}function j(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function q(t){return t.maxX-t.minX+(t.maxY-t.minY)}function xt(t,e){return(Math.max(e.maxX,t.maxX)-Math.min(e.minX,t.minX))*(Math.max(e.maxY,t.maxY)-Math.min(e.minY,t.minY))}function vt(t,e){var s=Math.max(t.minX,e.minX),i=Math.max(t.minY,e.minY),r=Math.min(t.maxX,e.maxX),o=Math.min(t.maxY,e.maxY);return Math.max(0,r-s)*Math.max(0,o-i)}function G(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function V(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function z(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function re(t,e,s,i,r){for(var o,n=[e,s];n.length;)(s=n.pop())-(e=n.pop())<=i||(o=e+Math.ceil((s-e)/i/2)*i,Xe(t,o,e,s,r),n.push(e,o,o,s))}W.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,s=[],i=this.toBBox;if(!V(t,e))return s;for(var r,o,n,l,h=[];e;){for(r=0,o=e.children.length;r<o;r++)n=e.children[r],V(t,l=e.leaf?i(n):n)&&(e.leaf?s.push(n):G(t,l)?this._all(n,s):h.push(n));e=h.pop()}return s},collides:function(t){var e=this.data,s=this.toBBox;if(!V(t,e))return!1;for(var i,r,o,n,l=[];e;){for(i=0,r=e.children.length;i<r;i++)if(o=e.children[i],V(t,n=e.leaf?s(o):o)){if(e.leaf||G(t,n))return!0;l.push(o)}e=l.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,s=t.length;e<s;e++)this.insert(t[e]);return this}var i=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){var r=this.data;this.data=i,i=r}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i;return this},insert:function(t){return t!=null&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=z([]),this},remove:function(t,e){if(t==null)return this;for(var s,i,r,o,n=this.data,l=this.toBBox(t),h=[],a=[];n||h.length;){if(n||(n=h.pop(),i=h[h.length-1],s=a.pop(),o=!0),n.leaf&&(r=yt(t,n.children,e))!==-1)return n.children.splice(r,1),h.push(n),this._condense(h),this;o||n.leaf||!G(n,l)?i?(s++,n=i.children[s],o=!1):n=null:(h.push(n),a.push(s),s=0,i=n,n=n.children[0])}return this},toBBox:function(t){return t},compareMinX:se,compareMinY:ie,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var s=[];t;)t.leaf?e.push.apply(e,t.children):s.push.apply(s,t.children),t=s.pop();return e},_build:function(t,e,s,i){var r,o=s-e+1,n=this._maxEntries;if(o<=n)return F(r=z(t.slice(e,s+1)),this.toBBox),r;i||(i=Math.ceil(Math.log(o)/Math.log(n)),n=Math.ceil(o/Math.pow(n,i-1))),(r=z([])).leaf=!1,r.height=i;var l,h,a,c,u=Math.ceil(o/n),f=u*Math.ceil(Math.sqrt(n));for(re(t,e,s,f,this.compareMinX),l=e;l<=s;l+=f)for(re(t,l,a=Math.min(l+f-1,s),u,this.compareMinY),h=l;h<=a;h+=u)c=Math.min(h+u-1,a),r.children.push(this._build(t,h,c,i-1));return F(r,this.toBBox),r},_chooseSubtree:function(t,e,s,i){for(var r,o,n,l,h,a,c,u;i.push(e),!e.leaf&&i.length-1!==s;){for(c=u=1/0,r=0,o=e.children.length;r<o;r++)h=j(n=e.children[r]),(a=xt(t,n)-h)<u?(u=a,c=h<c?h:c,l=n):a===u&&h<c&&(c=h,l=n);e=l||e.children[0]}return e},_insert:function(t,e,s){var i=this.toBBox,r=s?t:i(t),o=[],n=this._chooseSubtree(r,this.data,e,o);for(n.children.push(t),Y(n,r);e>=0&&o[e].children.length>this._maxEntries;)this._split(o,e),e--;this._adjustParentBBoxes(r,o,e)},_split:function(t,e){var s=t[e],i=s.children.length,r=this._minEntries;this._chooseSplitAxis(s,r,i);var o=this._chooseSplitIndex(s,r,i),n=z(s.children.splice(o,s.children.length-o));n.height=s.height,n.leaf=s.leaf,F(s,this.toBBox),F(n,this.toBBox),e?t[e-1].children.push(n):this._splitRoot(s,n)},_splitRoot:function(t,e){this.data=z([t,e]),this.data.height=t.height+1,this.data.leaf=!1,F(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,s){var i,r,o,n,l,h,a,c;for(h=a=1/0,i=e;i<=s-e;i++)n=vt(r=O(t,0,i,this.toBBox),o=O(t,i,s,this.toBBox)),l=j(r)+j(o),n<h?(h=n,c=i,a=l<a?l:a):n===h&&l<a&&(a=l,c=i);return c},_chooseSplitAxis:function(t,e,s){var i=t.leaf?this.compareMinX:se,r=t.leaf?this.compareMinY:ie;this._allDistMargin(t,e,s,i)<this._allDistMargin(t,e,s,r)&&t.children.sort(i)},_allDistMargin:function(t,e,s,i){t.children.sort(i);var r,o,n=this.toBBox,l=O(t,0,e,n),h=O(t,s-e,s,n),a=q(l)+q(h);for(r=e;r<s-e;r++)o=t.children[r],Y(l,t.leaf?n(o):o),a+=q(l);for(r=s-e-1;r>=e;r--)o=t.children[r],Y(h,t.leaf?n(o):o),a+=q(h);return a},_adjustParentBBoxes:function(t,e,s){for(var i=s;i>=0;i--)Y(e[i],t)},_condense:function(t){for(var e,s=t.length-1;s>=0;s--)t[s].children.length===0?s>0?(e=t[s-1].children).splice(e.indexOf(t[s]),1):this.clear():F(t[s],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}};function Mt(t,{timeZone:e,timeExtent:s}){return{$view:{scale:t,timeZone:e,timeProperties:{currentStart:s==null?void 0:s.start,currentEnd:s==null?void 0:s.end}}}}class ve{constructor(e,s){this.key=new X(0,0,0,0),this.bounds=K(),this.objectIds=new Set,this.key.set(s);const i=e.getLODInfoAt(this.key);this.tileInfoView=e,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=i.resolution,this.level=i.level,this.scale=i.scale,this.minScale=e.zoomToScale(i.level-1),this.maxScale=e.zoomToScale(i.level+1)}get lod(){return this.tileInfoView.getLODInfoAt(this.key)}get id(){return this.key.id}get extent(){return Fe(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createArcadeEvaluationOptions(e){return Mt(this.scale,e)}createChildTiles(){const e=this.key.getChildKeys(),s=ze.acquire();for(let i=0;i<e.length;i++)s[i]=new ve(this.tileInfoView,e[i]);return s}getQuantizationParameters(){return ke.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}var oe,ne,le,he,ae,ce,ue,fe,de;(function(t){t[t.FILL=0]="FILL",t[t.LINE=1]="LINE",t[t.MARKER=2]="MARKER",t[t.TEXT=3]="TEXT",t[t.LABEL=4]="LABEL"})(oe||(oe={})),function(t){t[t.NONE=0]="NONE",t[t.MAP=1]="MAP",t[t.LABEL=2]="LABEL",t[t.LABEL_ALPHA=4]="LABEL_ALPHA",t[t.HITTEST=8]="HITTEST",t[t.HIGHLIGHT=16]="HIGHLIGHT",t[t.CLIP=32]="CLIP",t[t.DEBUG=64]="DEBUG",t[t.NUM_DRAW_PHASES=9]="NUM_DRAW_PHASES"}(ne||(ne={})),function(t){t[t.SIZE=0]="SIZE",t[t.COLOR=1]="COLOR",t[t.OPACITY=2]="OPACITY",t[t.ROTATION=3]="ROTATION"}(le||(le={})),function(t){t[t.MINMAX_TARGETS_OUTLINE=128]="MINMAX_TARGETS_OUTLINE",t[t.SCALE_TARGETS_OUTLINE=256]="SCALE_TARGETS_OUTLINE",t[t.FIELD_TARGETS_OUTLINE=512]="FIELD_TARGETS_OUTLINE",t[t.UNIT_TARGETS_OUTLINE=1024]="UNIT_TARGETS_OUTLINE"}(he||(he={})),function(t){t[t.SPRITE=0]="SPRITE",t[t.GLYPH=1]="GLYPH"}(ae||(ae={})),function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SIMPLE=1]="SIMPLE",t[t.DOT_DENSITY=2]="DOT_DENSITY",t[t.OUTLINE_FILL=3]="OUTLINE_FILL",t[t.OUTLINE_FILL_SIMPLE=4]="OUTLINE_FILL_SIMPLE",t[t.HEATMAP=5]="HEATMAP",t[t.PIE_CHART=6]="PIE_CHART"}(ce||(ce={})),function(t){t[t.All=0]="All",t[t.Highlight=1]="Highlight",t[t.InsideEffect=2]="InsideEffect",t[t.OutsideEffect=3]="OutsideEffect"}(ue||(ue={})),function(t){t[t.BATCHING=0]="BATCHING",t[t.STRICT_ORDER=1]="STRICT_ORDER",t[t.STRICT_MARKERS_AND_TEXT=2]="STRICT_MARKERS_AND_TEXT"}(fe||(fe={})),function(t){t[t.FILL=0]="FILL",t[t.LINE=1]="LINE",t[t.MARKER=2]="MARKER",t[t.TEXT=3]="TEXT"}(de||(de={}));export{ae as A,ne as E,le as L,We as M,fe as N,ue as R,de as S,W as a,De as b,Ve as c,je as d,_e as e,ut as f,Mt as g,$t as h,Ke as i,ve as j,Ge as k,Je as l,Ze as m,ht as n,Ot as p,Yt as r,ye as s,He as u};
