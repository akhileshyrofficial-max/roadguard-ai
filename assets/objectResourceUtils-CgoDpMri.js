const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/loader-CEUQ1EaK.js","assets/Identifiable-BjM0PfdN.js","assets/index-CVvIVqY1.js","assets/mat4f64-q_b6UJoq.js","assets/enums-UBzvFP7O.js","assets/Version-CWer4Z2d.js","assets/mat4-C8ai-EIY.js","assets/common-DQOJ18NT.js","assets/quat-CXDqupE8.js","assets/mat3f64-B5o_lm6j.js","assets/quatf64-aQ5IuZRd.js","assets/vec32-rHWgUfNj.js","assets/vec42-CKs01hkn.js","assets/BufferView-DhGQO6iM.js","assets/vec2-ChnYg_BJ.js","assets/vec2f64-Cgb6qxNH.js","assets/vec4f64-DPb6J-GU.js","assets/resourceUtils-BSNzF59o.js","assets/basicInterfaces-CZwQPxTp.js"])))=>i.map(i=>d[i]);
import{_ as we}from"./index-CVvIVqY1.js";import{ck as Y,H as ve,E as ae,i as $e,s as Re,v as z,bV as ie,df as Z}from"./Identifiable-BjM0PfdN.js";import{a as Ae}from"./devEnvironmentUtils-CnNDiFMM.js";import{i as J,j as Me,n as Be}from"./mat3-CruJiiUv.js";import{n as Q,e as le}from"./mat3f64-B5o_lm6j.js";import{h as Oe}from"./mat4-C8ai-EIY.js";import{e as Pe}from"./mat4f64-q_b6UJoq.js";import{a as Se}from"./vec2f64-Cgb6qxNH.js";import{E as X,c as Ie,i as ee,r as Ee,A as _e,I as Ce}from"./vec32-rHWgUfNj.js";import{q as ue,l as N}from"./aaBoundingBox-BrXqvn3i.js";import{L as ce,p as me,n as q}from"./OutputColorHighlightOID.glsl-tatNY0O9.js";import{o as fe,T as de,g as ke,M as Fe,O as Ue,V as je}from"./BufferView-DhGQO6iM.js";import{r as Le,n as qe,d as re,l as te}from"./vec3-DJlvs4Tc.js";import{o as Ve,d as se}from"./vec4-Crh6Uaha.js";import{n as Ne,o as De,a as Ge}from"./indexUtils-u02ZFw2e.js";import{n as V}from"./resourceUtils-BSNzF59o.js";import{a as We,i as He}from"./vec2f32-CaVKkSa6.js";import{_ as pe}from"./asyncUtils-zc5DpkIL.js";import{u as ze}from"./memoryEstimations-m6Z1UQ7X.js";import{t as Qe}from"./NestedMap-C3hRTnZR.js";import{r as he}from"./Version-CWer4Z2d.js";import{A as Ke}from"./Indices-CMRHW2O4.js";import{t as Ye}from"./requestImageUtils-DDbYZwJ1.js";import{t as k}from"./orientedBoundingBox-lR12qwpS.js";import{e as K,i as A,n as Ze}from"./basicInterfaces-CZwQPxTp.js";import{e as _}from"./VertexAttribute-BfkzOMLV.js";import{W as D,n as Je,o as Xe,s as er,t as rr}from"./DefaultMaterial-DmYHHZ7G.js";import{P as oe}from"./enums-UBzvFP7O.js";import{a as ne}from"./NormalAttribute.glsl-DeAV_F6P.js";function F(t){if(t==null)return null;const e=t.offset!=null?t.offset:We,o=t.rotation!=null?t.rotation:0,s=t.scale!=null?t.scale:He,u=Q(1,0,0,0,1,0,e[0],e[1],1),i=Q(Math.cos(o),-Math.sin(o),0,Math.sin(o),Math.cos(o),0,0,0,1),n=Q(s[0],0,0,0,s[1],0,0,0,1),a=le();return J(a,i,n),J(a,u,a),a}class tr{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class sr{constructor(e,o,s){this.name=e,this.lodThreshold=o,this.pivotOffset=s,this.stageResources=new tr,this.numberOfVertices=0}}const P=()=>$e.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");class or{constructor(e,o,s){this.resource=e,this.textures=o,this.cachedMemory=s}}async function nr(t,e){const o=await ar(t,e),s=await mr(o.textureDefinitions??{},e);let u=0;for(const i in s)if(s.hasOwnProperty(i)){const n=s[i];u+=n!=null&&n.image?n.image.width*n.image.height*4:0}return new or(o,s,u+ze(o))}async function ar(t,e){const o=e==null?void 0:e.streamDataRequester;if(o)return ir(t,o,e);const s=await pe(ve(t,e));if(s.ok===!0)return s.value.data;ae(s.error),xe(s.error)}async function ir(t,e,o){const s=await pe(e.request(t,"json",o));if(s.ok===!0)return s.value;ae(s.error),xe(s.error.details.url)}function xe(t){throw new Re("",`Request for object resource failed: ${t}`)}function lr(t){const e=t.params,o=e.topology;let s=!0;switch(e.vertexAttributes||(P().warn("Geometry must specify vertex attributes"),s=!1),e.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const i=e.faces;if(i){if(e.vertexAttributes)for(const n in e.vertexAttributes){const a=i[n];a!=null&&a.values?(a.valueType!=null&&a.valueType!=="UInt32"&&(P().warn(`Unsupported indexed geometry indices type '${a.valueType}', only UInt32 is currently supported`),s=!1),a.valuesPerElement!=null&&a.valuesPerElement!==1&&(P().warn(`Unsupported indexed geometry values per element '${a.valuesPerElement}', only 1 is currently supported`),s=!1)):(P().warn(`Indexed geometry does not specify face indices for '${n}' attribute`),s=!1)}}else P().warn("Indexed geometries must specify faces"),s=!1;break}default:P().warn(`Unsupported topology '${o}'`),s=!1}t.params.material||(P().warn("Geometry requires material"),s=!1);const u=t.params.vertexAttributes;for(const i in u)u[i].values||(P().warn("Geometries with externally defined attributes are not yet supported"),s=!1);return s}function ur(t,e){var x,d;const o=new Array,s=new Array,u=new Array,i=new Qe,n=t.resource,a=he.parse(n.version||"1.0","wosr");dr.validate(a);const m=n.model.name,r=n.model.geometries,l=n.materialDefinitions??{},c=t.textures;let p=0;const h=new Map;for(let b=0;b<r.length;b++){const g=r[b];if(!lr(g))continue;const v=fr(g),w=g.params.vertexAttributes,R=[],T=f=>{if(g.params.topology==="PerAttributeArray")return null;const $=g.params.faces;for(const y in $)if(y===f)return $[y].values;return null},S=w[_.POSITION],U=S.values.length/S.valuesPerElement;for(const f in w){const $=w[f],y=$.values,W=T(f)??Ke(U);R.push([f,new k(y,W,$.valuesPerElement,!0)])}const M=v.texture,B=c&&c[M];if(B&&!h.has(M)){const{image:f,parameters:$}=B,y=new ce(f,$);s.push(y),h.set(M,y)}const j=h.get(M),G=j?j.id:void 0,O=v.material;let I=i.get(O,M);if(I==null){const f=l[O.slice(O.lastIndexOf("/")+1)].params;f.transparency===1&&(f.transparency=0);const $=B?ge(B.alphaChannelUsage):void 0,y={ambient:Y(f.diffuse),diffuse:Y(f.diffuse),opacity:1-(f.transparency||0),textureAlphaMode:$,textureAlphaCutoff:.33,textureId:G,doubleSided:!0,cullFace:K.None,colorMixMode:f.externalColorMixMode||"tint",textureAlphaPremultiplied:(B==null?void 0:B.parameters.preMultiplyAlpha)??!1};e!=null&&e.materialParameters&&Object.assign(y,e.materialParameters),I=new D(y,e),i.set(O,M,I)}u.push(I);const L=new me(I,R);p+=((d=(x=R.find(f=>f[0]===_.POSITION))==null?void 0:x[1])==null?void 0:d.indices.length)??0,o.push(L)}return{engineResources:[{name:m,stageResources:{textures:s,materials:u,geometries:o},pivotOffset:n.model.pivotOffset,numberOfVertices:p,lodThreshold:null}],referenceBoundingBox:cr(o)}}function cr(t){const e=ue();return t.forEach(o=>{const s=o.boundingInfo;s!=null&&(N(e,s.bbMin),N(e,s.bbMax))}),e}async function mr(t,e){const o=new Array;for(const i in t){const n=t[i],a=n.images[0].data;if(!a){P().warn("Externally referenced texture data is not yet supported");continue}const m=n.encoding+";base64,"+a,r="/textureDefinitions/"+i,l=n.channels==="rgba"?n.alphaChannelUsage||"transparency":"none",c={noUnpackFlip:!0,wrap:{s:oe.REPEAT,t:oe.REPEAT},preMultiplyAlpha:ge(l)!==A.Opaque},p=e!=null&&e.disableTextures?Promise.resolve(null):Ye(m,e);o.push(p.then(h=>({refId:r,image:h,parameters:c,alphaChannelUsage:l})))}const s=await Promise.all(o),u={};for(const i of s)u[i.refId]=i;return u}function ge(t){switch(t){case"mask":return A.Mask;case"maskAndTransparency":return A.MaskBlend;case"none":return A.Opaque;default:return A.Blend}}function fr(t){const e=t.params;return{id:1,material:e.material,texture:e.texture,region:e.texture}}const dr=new he(1,2,"wosr");async function pr(t,e){var c;const o=ye(Ae(t));if(o.fileType==="wosr"){const p=await(e.cache?e.cache.loadWOSR(o.url,e):nr(o.url,e)),{engineResources:h,referenceBoundingBox:x}=ur(p,e);return{lods:h,referenceBoundingBox:x,isEsriSymbolResource:!1,isWosr:!0}}let s;if(e.cache)s=await e.cache.loadGLTF(o.url,e,!!e.usePBR);else{const{loadGLTF:p}=await we(()=>import("./loader-CEUQ1EaK.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]));s=await p(new Ne(e.streamDataRequester),o.url,e,e.usePBR)}const u=(c=s.model.meta)==null?void 0:c.ESRI_proxyEllipsoid,i=s.meta.isEsriSymbolResource&&u!=null&&s.meta.ESRI_webstyle==="EsriRealisticTreesStyle";i&&!s.customMeta.esriTreeRendering&&(s.customMeta.esriTreeRendering=!0,Tr(s,u));const n=!!e.usePBR,a=s.meta.isEsriSymbolResource?{usePBR:n,isSchematic:!1,treeRendering:i,mrrFactors:er}:{usePBR:n,isSchematic:!1,treeRendering:!1,mrrFactors:rr},m={...e.materialParameters,treeRendering:i},{engineResources:r,referenceBoundingBox:l}=hr(s,a,m,e,o.specifiedLodIndex,i);return{lods:r,referenceBoundingBox:l,isEsriSymbolResource:s.meta.isEsriSymbolResource,isWosr:!1}}function ye(t){const e=t.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return e?{fileType:"gltf",url:e[1],specifiedLodIndex:e[4]!=null?Number(e[4]):null}:t.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:t,specifiedLodIndex:null}:{fileType:"unknown",url:t,specifiedLodIndex:null}}function hr(t,e,o,s,u,i){const n=t.model,a=new Array,m=new Map,r=new Map,l=n.lods.length,c=ue();return n.lods.forEach((p,h)=>{const x=s.skipHighLods===!0&&(l>1&&h===0||l>3&&h===1)||s.skipHighLods===!1&&u!=null&&h!==u;if(x&&h!==0)return;const d=new sr(p.name,p.lodThreshold,[0,0,0]);p.parts.forEach(b=>{const g=x?new D({},s):xr(n,b,d,e,o,m,r,s,i),{geometry:v,vertexCount:w}=gr(b,g??new D({},s)),R=v.boundingInfo;R!=null&&h===0&&(N(c,R.bbMin),N(c,R.bbMax)),g!=null&&(d.stageResources.geometries.push(v),d.numberOfVertices+=w)}),x||a.push(d)}),{engineResources:a,referenceBoundingBox:c}}function xr(t,e,o,s,u,i,n,a,m){var w,R;const r=t.materials.get(e.material);if(r==null)return null;const{normal:l,color:c,texCoord0:p,tangent:h}=e.attributes,x=e.material+(l?"_normal":"")+(c?"_color":"")+(p?"_texCoord0":"")+(h?"_tangent":""),d=e.attributes.texCoord0!=null,b=e.attributes.normal!=null,g=yr(r.alphaMode);if(!i.has(x)){if(d){const f=(y,W=!1,Te=!1)=>{if(y!=null&&!n.has(y)){const H=t.textures.get(y);if(H){const E=H.data,be=W&&!V(E)?a.compressionOptions:void 0;n.set(y,new ce(V(E)?E.data:E,{...H.parameters,preMultiplyAlpha:!V(E)&&Te,encoding:V(E)?E.encoding:void 0,compressionOptions:be}))}}},$=g!==A.Opaque&&!m;f(r.colorTexture,$,g!==A.Opaque),f(r.normalTexture),f(r.occlusionTexture,!0),f(r.emissiveTexture),f(r.metallicRoughnessTexture,!0)}const T=1/ie,S=r.color[0]**T,U=r.color[1]**T,M=r.color[2]**T,B=r.emissiveFactor[0]**T,j=r.emissiveFactor[1]**T,G=r.emissiveFactor[2]**T,O=r.colorTexture!=null&&d?n.get(r.colorTexture):null,I=Je(r),L=((w=r.normalTextureTransform)==null?void 0:w.scale)!=null?(R=r.normalTextureTransform)==null?void 0:R.scale:Se;i.set(x,new D({...s,customDepthTest:Ze.Lequal,textureAlphaMode:g,textureAlphaCutoff:r.alphaCutoff,diffuse:[S,U,M],ambient:[S,U,M],opacity:r.alphaMode==="OPAQUE"?1:r.opacity,doubleSided:r.doubleSided,doubleSidedType:"winding-order",cullFace:r.doubleSided?K.None:K.Back,hasVertexColors:!!e.attributes.color,hasVertexTangents:!!e.attributes.tangent,normalType:b?ne.Attribute:ne.ScreenDerivative,castShadows:!0,receiveShadows:r.receiveShadows,receiveAmbientOcclusion:r.receiveAmbientOcclusion,textureId:O!=null?O.id:void 0,colorMixMode:r.colorMixMode,normalTextureId:r.normalTexture!=null&&d?n.get(r.normalTexture).id:void 0,textureAlphaPremultiplied:O!=null&&!!O.parameters.preMultiplyAlpha,occlusionTextureId:r.occlusionTexture!=null&&d?n.get(r.occlusionTexture).id:void 0,emissiveTextureId:r.emissiveTexture!=null&&d?n.get(r.emissiveTexture).id:void 0,metallicRoughnessTextureId:r.metallicRoughnessTexture!=null&&d?n.get(r.metallicRoughnessTexture).id:void 0,emissiveBaseColor:[B,j,G],mrrFactors:I?Xe:[r.metallicFactor,r.roughnessFactor,s.mrrFactors[2]],isSchematic:I,colorTextureTransformMatrix:F(r.colorTextureTransform),normalTextureTransformMatrix:F(r.normalTextureTransform),scale:[L[0],L[1]],occlusionTextureTransformMatrix:F(r.occlusionTextureTransform),emissiveTextureTransformMatrix:F(r.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:F(r.metallicRoughnessTextureTransform),...u},a))}const v=i.get(x);if(o.stageResources.materials.push(v),d){const T=S=>{S!=null&&o.stageResources.textures.push(n.get(S))};T(r.colorTexture),T(r.normalTexture),T(r.occlusionTexture),T(r.emissiveTexture),T(r.metallicRoughnessTexture)}return v}function gr(t,e){const o=t.attributes.position.count,s=De(t.indices||o,t.primitiveType),u=q(3*o),{typedBuffer:i,typedBufferStride:n}=t.attributes.position;Le(u,i,t.transform,3,n);const a=[[_.POSITION,new k(u,s,3,!0)]];if(t.attributes.normal!=null){const r=q(3*o),{typedBuffer:l,typedBufferStride:c}=t.attributes.normal;Me(C,t.transform),qe(r,l,C,3,c),Z(C)&&re(r,r),a.push([_.NORMAL,new k(r,s,3,!0)])}if(t.attributes.tangent!=null){const r=q(4*o),{typedBuffer:l,typedBufferStride:c}=t.attributes.tangent;Be(C,t.transform),Ve(r,l,C,4,c),Z(C)&&re(r,r,4),a.push([_.TANGENT,new k(r,s,4,!0)])}if(t.attributes.texCoord0!=null){const r=q(2*o),{typedBuffer:l,typedBufferStride:c}=t.attributes.texCoord0;Ge(r,l,2,c),a.push([_.UV0,new k(r,s,2,!0)])}const m=t.attributes.color;if(m!=null){const r=new Uint8Array(4*o);m.elementCount===4?m instanceof de?se(r,m,1,255):(m instanceof ke||m instanceof Fe)&&se(r,m,1/255,255):(r.fill(255),m instanceof fe?te(r,m.typedBuffer,1,255,4,m.typedBufferStride):(t.attributes.color instanceof Ue||t.attributes.color instanceof je)&&te(r,m.typedBuffer,1/255,255,4,t.attributes.color.typedBufferStride)),a.push([_.COLOR,new k(r,s,4,!0)])}return{geometry:new me(e,a),vertexCount:o}}const C=le();function yr(t){switch(t){case"BLEND":return A.Blend;case"MASK":return A.Mask;case"OPAQUE":case null:case void 0:return A.Opaque}}function Tr(t,e){for(let o=0;o<t.model.lods.length;++o){const s=t.model.lods[o];for(const u of s.parts){const i=u.attributes.normal;if(i==null)return;const n=u.attributes.position,a=n.count,m=z(),r=z(),l=z(),c=new Float32Array(4*a),p=new Float32Array(3*a),h=Oe(Pe(),u.transform);let x=0,d=0;for(let b=0;b<a;b++){n.getVec(b,r),i.getVec(b,m),X(r,r,u.transform),Ie(l,r,e.center),ee(l,l,e.radius);const g=l[2],v=Ee(l),w=Math.min(.45+.55*v*v,1)**ie;ee(l,l,e.radius),h!==null&&X(l,l,h),_e(l,l),o+1!==t.model.lods.length&&t.model.lods.length>1&&Ce(l,l,m,g>-1?.2:Math.min(-4*g-3.8,1)),p[x]=l[0],p[x+1]=l[1],p[x+2]=l[2],x+=3,c[d]=w,c[d+1]=w,c[d+2]=w,c[d+3]=1,d+=4}u.attributes.normal=new fe(p),u.attributes.color=new de(c)}}}const Kr=Object.freeze(Object.defineProperty({__proto__:null,fetch:pr,parseUrl:ye},Symbol.toStringTag,{value:"Module"}));export{pr as Y,Kr as o,F as s};
