import{h as c,r as y,i as T}from"./TimeOnly-YXxQ25V6.js";import{s as w,aL as b,aW as g}from"./Identifiable-_3rFZ1o6.js";import{f as S}from"./jsonUtils-Cc67rW5Z.js";import{Z as x}from"./FieldsIndex-BTwzr3dJ.js";import{a as D}from"./fieldUtils-z3GG2R-H.js";const F=["geometry","scale","timeProperties"];function P(a,e){if(e!=null)for(const t of F)e.hasArcadeDependency(t)&&a.add(t);return a}function k(a,e){return u.create(a,e,null,["$feature","$view"])}function O(a,e,t){return u.create(a,e,t,["$feature","$view","$config"])}class u{static async create(e,t,i,r){const{arcade:s,Dictionary:o}=await D();let n;try{n=s.parseScript(e)}catch(f){throw new w("arcade-bad-expression","Failed to parse arcade script",{script:e,error:f})}const l=s.scriptUsesGeometryEngine(n);l&&await s.enableGeometrySupport(),await s.loadDependentModules(new Set,n,null,!1,l);const m={vars:r.reduce((f,_)=>({...f,[_]:null}),{}),spatialReference:t,useAsync:!1},p=s.compileScript(n,m);let d=null;i!=null&&(d=new o(i),d.immutable=!0);const h=new o;return h.immutable=!1,h.setField("scale",0),new u(e,s,n,p,t,h,d,o)}constructor(e,t,i,r,s,o,n,l){this.script=e,this._arcade=t,this._syntaxTree=i,this._compiled=r,this._spatialReference=s,this._viewDict=o,this._configDict=n,this._dictionaryCtor=l,this._dependencies=new Map,this._featureReader=new v,this._dependencies.set("geometry",t.scriptTouchesGeometry(this._syntaxTree)),this._dependencies.set("scale",this._arcade.referencesMember(this._syntaxTree,"scale")),this._dependencies.set("timeProperties",this._arcade.scriptUsesViewProperties(this._syntaxTree,["timeProperties"]))}evaluate(e,t){var r;const i=(r=t.$view)==null?void 0:r.timeZone;if(t.$view){let s;if(this._viewDict.setField("scale",t.$view.scale),t.$view.timeProperties!=null){const{currentStart:o,currentEnd:n}=t.$view.timeProperties;s=new this._dictionaryCtor({currentStart:o!=null?i!=null?c.epochToArcadeDate(o,i):c.unknownEpochToArcadeDate(o):void 0,currentEnd:n!=null?i!=null?c.epochToArcadeDate(n,i):c.unknownEpochToArcadeDate(n):void 0,startIncluded:!0,endIncluded:!0})}this._viewDict.setField("timeProperties",s)}return this._compiled({vars:{$view:this._viewDict,$config:this._configDict,$feature:e},spatialReference:this._spatialReference,timeZone:i})}repurposeFeature(e,t){return this._featureReader.bind(e,t,this._spatialReference),this._featureReader}references(e){return this._dependencies.get(e)??!1}}class v{constructor(){this._boundTarget=null,this._boundSchema={fields:null,fieldsIndex:null,spatialReference:null,get geometryType(){return null},get objectIdField(){return null}},this.arcadeDeclaredClass="esri.arcade.Feature",this._contextTimeZone=null}bind(e,t,i){const r=t??new x(R(e.attributes));this._boundTarget=e,this._boundSchema.fields=r.fields,this._boundSchema.fieldsIndex=r,this._boundSchema.spatialReference=i}_getField(e){return this._boundSchema.fieldsIndex.get(e)}get contextTimeZone(){return this._contextTimeZone}set contextTimeZone(e){this._contextTimeZone=e}readArcadeFeature(){return this}hasField(e){return this._boundSchema.fieldsIndex.has(e)}geometry(){if("fromJSON"in this._boundTarget)return this._boundTarget.geometry;const e=S(this._boundTarget.geometry);if(e){if(!this._boundSchema.spatialReference)throw new Error("InternalError: Expected spatial reference to be defined");e.spatialReference=this._boundSchema.spatialReference}return e}isUnknownDateTimeField(e){return this._boundSchema.fieldsIndex.getTimeZone(e)===b}field(e,t=!0){const i=this._getField(e);if(i){const r=this._boundTarget.attributes[i.name];if(r==null)return null;switch(i.type){case"date-only":case"esriFieldTypeDateOnly":return T.fromReader(r);case"time-only":case"esriFieldTypeTimeOnly":return y.fromReader(r);case"esriFieldTypeTimestampOffset":case"timestamp-offset":return c.fromReaderAsTimeStampOffset(r);case"date":case"esriFieldTypeDate":return this.isUnknownDateTimeField(e)?c.unknownEpochToArcadeDate(r):c.epochToArcadeDate(r,this.contextTimeZone??g);default:return r}}if(t)throw new Error(`Field ${e} does not exist`);return null}setField(e,t){throw new Error("Unable to update feature attribute values, feature is readonly")}keys(){return this._boundSchema.fieldsIndex.fields.map(e=>e.name)}castToText(e=!1){return JSON.stringify(this._boundTarget)}gdbVersion(){return null}fullSchema(){return this._boundSchema}castAsJson(e=null){var t;return{attributes:this._boundTarget.attributes,geometry:(e==null?void 0:e.keepGeometryType)===!0?this.geometry():((t=this.geometry())==null?void 0:t.toJSON())??null}}castAsJsonAsync(e=null,t=null){return Promise.resolve(this.castAsJson(t))}}function R(a){const e=[];for(const t in a)e.push({name:t,alias:t,type:typeof a[t]=="string"?"esriFieldTypeString":"esriFieldTypeDouble"});return e}export{R as _,P as d,v as f,k as h,O as m};
