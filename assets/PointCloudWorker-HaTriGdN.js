import{dm as O,L as x,al as v}from"./Identifiable-_3rFZ1o6.js";import{O as C}from"./quat-9ZYTS2cW.js";import{e as k}from"./quatf64-aQ5IuZRd.js";import{Q as F}from"./vec32-soPbwaVZ.js";import{t as A,n as w}from"./vec3f32-WCVSSNPR.js";import{a as R}from"./projectionUtils-BdqPecQc.js";import{u as U,d as B,a as J}from"./PointCloudUniqueValueRenderer-BfOFAjgM.js";import{U as N,w as V,c as T,D as q}from"./I3SBinaryReader-BcB41eUM.js";import{I as $}from"./orientedBoundingBox-hrOoocb4.js";import"./index-BEHHhRxI.js";import"./mat3f64-B5o_lm6j.js";import"./common-DQOJ18NT.js";import"./vec42-CKs01hkn.js";import"./RendererLegendOptions-DWy2dLCX.js";import"./ColorStop-DY3WB4ha.js";import"./VertexAttribute-BfkzOMLV.js";import"./mat3-CruJiiUv.js";import"./mat4f64-q_b6UJoq.js";import"./vec4f64-DPb6J-GU.js";import"./spatialReferenceEllipsoidUtils-DTRGV_GU.js";import"./computeTranslationToOriginAndRotation-BC1si6zj.js";import"./mat4-CEszlm-2.js";import"./plane-BnjjlcHJ.js";import"./vectorStacks-Cflk7ctu.js";import"./vec2f64-Cgb6qxNH.js";import"./ViewingMode-Chk7YAAL.js";function z(a,t,l,n){const{rendererJSON:s,isRGBRenderer:p}=a;let o=null,i=null;if(t&&p)o=t;else if(t&&(s==null?void 0:s.type)==="pointCloudUniqueValueRenderer"){i=U.fromJSON(s);const e=i.colorUniqueValueInfos;o=new Uint8Array(3*n);const c=g(i.fieldTransformType);for(let r=0;r<n;r++){const f=(c?c(t[r]):t[r])+"";for(let u=0;u<e.length;u++)if(e[u].values.includes(f)){o[3*r]=e[u].color.r,o[3*r+1]=e[u].color.g,o[3*r+2]=e[u].color.b;break}}}else if(t&&(s==null?void 0:s.type)==="pointCloudStretchRenderer"){i=B.fromJSON(s);const e=i.stops;o=new Uint8Array(3*n);const c=g(i.fieldTransformType);for(let r=0;r<n;r++){const f=c?c(t[r]):t[r],u=e.length-1;if(f<e[0].value)o[3*r]=e[0].color.r,o[3*r+1]=e[0].color.g,o[3*r+2]=e[0].color.b;else if(f>=e[u].value)o[3*r]=e[u].color.r,o[3*r+1]=e[u].color.g,o[3*r+2]=e[u].color.b;else for(let m=1;m<e.length;m++)if(f<e[m].value){const b=(f-e[m-1].value)/(e[m].value-e[m-1].value);o[3*r]=e[m].color.r*b+e[m-1].color.r*(1-b),o[3*r+1]=e[m].color.g*b+e[m-1].color.g*(1-b),o[3*r+2]=e[m].color.b*b+e[m-1].color.b*(1-b);break}}}else if(t&&(s==null?void 0:s.type)==="pointCloudClassBreaksRenderer"){i=J.fromJSON(s);const e=i.colorClassBreakInfos;o=new Uint8Array(3*n);const c=g(i.fieldTransformType);for(let r=0;r<n;r++){const f=c?c(t[r]):t[r];for(let u=0;u<e.length;u++)if(f>=e[u].minValue&&f<=e[u].maxValue){o[3*r]=e[u].color.r,o[3*r+1]=e[u].color.g,o[3*r+2]=e[u].color.b;break}}}else o=new Uint8Array(3*n).fill(255);if(l&&(i!=null&&i.colorModulation)){const e=i.colorModulation.minValue,c=i.colorModulation.maxValue,r=.3;for(let f=0;f<n;f++){const u=l[f],m=u>=c?1:u<=e?r:r+(1-r)*(u-e)/(c-e);o[3*f]=m*o[3*f],o[3*f+1]=m*o[3*f+1],o[3*f+2]=m*o[3*f+2]}}return o}function E(a,t){if(a.encoding==null||a.encoding===""){const l=N(t,a);if(l.vertexAttributes.position==null)return;const n=V(t,l.vertexAttributes.position),s=l.header.fields,p=[s.offsetX,s.offsetY,s.offsetZ],o=[s.scaleX,s.scaleY,s.scaleZ],i=n.length/3,e=new Float64Array(3*i);for(let c=0;c<i;c++)e[3*c]=n[3*c]*o[0]+p[0],e[3*c+1]=n[3*c+1]*o[1]+p[1],e[3*c+2]=n[3*c+2]*o[2]+p[2];return e}if(a.encoding==="lepcc-xyz")return T(t).result}function h(a,t,l){return a!=null&&a.attributeInfo.useElevation?t?L(t,l):null:a!=null&&a.attributeInfo.storageInfo?q(a.attributeInfo.storageInfo,a.buffer,l,!0):null}function L(a,t){const l=new Float64Array(t);for(let n=0;n<t;n++)l[n]=a[3*n+2];return l}function X(a,t,l,n,s){const p=a.length/3;let o=0;for(let i=0;i<p;i++){let e=!0;for(let c=0;c<n.length&&e;c++){const{filterJSON:r}=n[c],f=s[c].values[i];switch(r.type){case"pointCloudValueFilter":{const u=r.mode==="exclude";r.values.includes(f)===u&&(e=!1);break}case"pointCloudBitfieldFilter":{const u=M(r.requiredSetBits),m=M(r.requiredClearBits);(f&u)===u&&!(f&m)||(e=!1);break}case"pointCloudReturnFilter":{const u=15&f,m=f>>>4&15,b=m>1,S=u===1,I=u===m;let y=!1;for(const d of r.includedReturns)if(d==="last"&&I||d==="firstOfMany"&&S&&b||d==="lastOfMany"&&I&&b||d==="single"&&!b){y=!0;break}y||(e=!1);break}}}e&&(l[o]=i,a[3*o]=a[3*i],a[3*o+1]=a[3*i+1],a[3*o+2]=a[3*i+2],t[3*o]=t[3*i],t[3*o+1]=t[3*i+1],t[3*o+2]=t[3*i+2],o++)}return o}function g(a){switch(a){default:case null:case"none":return t=>t;case"low-four-bit":return t=>15&t;case"high-four-bit":return t=>(240&t)>>4;case"absolute-value":return t=>Math.abs(t);case"modulo-ten":return t=>t%10}}function M(a){let t=0;for(const l of a||[])t|=1<<l;return t}class Y{transform(t){const l=this._transform(t),n=[l.points.buffer,l.rgb.buffer];l.pointIdFilterMap!=null&&n.push(l.pointIdFilterMap.buffer);for(const s of l.attributes)"buffer"in s.values&&O(s.values.buffer)&&s.values.buffer!==l.rgb.buffer&&n.push(s.values.buffer);return Promise.resolve({result:l,transferList:n})}_transform(t){const l=E(t.schema,t.geometryBuffer);let n=l.length/3,s=null;const p=new Array,o=h(t.primaryAttributeData,l,n);t.primaryAttributeData!=null&&o&&p.push({attributeInfo:t.primaryAttributeData.attributeInfo,values:o});const i=h(t.modulationAttributeData,l,n);t.modulationAttributeData!=null&&i&&p.push({attributeInfo:t.modulationAttributeData.attributeInfo,values:i});let e=z(t.rendererInfo,o,i,n);if(t.filterInfo&&t.filterInfo.length>0&&t.filterAttributesData!=null){const r=t.filterAttributesData.filter(x).map(f=>{const u=h(f,l,n),m={attributeInfo:f.attributeInfo,values:u};return p.push(m),m});s=new Uint32Array(n),n=X(l,e,s,t.filterInfo,r)}for(const r of t.userAttributesData){const f=h(r,l,n);p.push({attributeInfo:r.attributeInfo,values:f})}3*n<e.length&&(e=new Uint8Array(e.buffer.slice(0,3*n))),_(l,n,t.elevationOffset);const c=Z(l,n,$.fromData(t.obbData),v.fromJSON(t.inSR),v.fromJSON(t.outSR));return{obbData:t.obbData,points:c,rgb:e,attributes:p,pointIdFilterMap:s}}}function Z(a,t,l,n,s){if(!R(a,n,0,a,s,0,t))throw new Error("Can't reproject");const p=A(l.center),o=w(),i=w(),e=A(l.halfSize);C(D,l.quaternion);const c=new Float32Array(3*t);for(let r=0;r<t;r++){let f=3*r;o[0]=a[f]-p[0],o[1]=a[f+1]-p[1],o[2]=a[f+2]-p[2],F(i,o,D),e[0]=Math.max(e[0],Math.abs(i[0])),e[1]=Math.max(e[1],Math.abs(i[1])),e[2]=Math.max(e[2],Math.abs(i[2])),c[f++]=o[0],c[f++]=o[1],c[f]=o[2]}return l.halfSize=e,c}function _(a,t,l){if(l!==0)for(let n=0;n<t;n++)a[3*n+2]+=l}const D=k();function yt(){return new Y}export{yt as default};
