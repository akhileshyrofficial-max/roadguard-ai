const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/visualVariableUtils-DciVTowe.js","assets/Identifiable-_3rFZ1o6.js","assets/index-BEHHhRxI.js","assets/Graphic-q_7OAYHf.js","assets/PopupTemplate-B09IYibB.js","assets/fieldUtils-z3GG2R-H.js","assets/jsonUtils-Cc67rW5Z.js","assets/typeUtils-mxDsOnhk.js","assets/createFeatureId-BiB9j2WD.js","assets/typeUtils-Buir9u-w.js","assets/SimpleMarkerSymbol-Drowg4jp.js","assets/screenUtils-aQeO9QTD.js","assets/aaBoundingBox-DNlIzH5i.js","assets/TextSymbol-keZwKiPd.js","assets/PictureMarkerSymbol-DlgeV3xL.js","assets/lengthUtils-CrwfL9_h.js"])))=>i.map(i=>d[i]);
import{V as H,L as Q,ct as K,T as B,b0 as X,c as n,m as p,ab as J,a3 as z,al as Y,d as I,ac as ee,H as te,x as re,cs as ie,a6 as oe,s as A,aS as se,aN as ae,aP as ne,b5 as le,aw as M}from"./Identifiable-_3rFZ1o6.js";import{j as ue,r as q,y as pe,a as ye}from"./fieldUtils-z3GG2R-H.js";import{_ as ce}from"./index-BEHHhRxI.js";import{i as he,u as de}from"./scaleUtils-B8vcNDUc.js";import{n as T}from"./floorFilterUtils-DZ5C6FQv.js";import{o as U}from"./drapedUtils-BVag5CrE.js";import{R as fe}from"./normalizeUtils-BS0bJnzn.js";import{f as me,u as ge,s as be}from"./utils-C73sopP7.js";import{v as we,f as ve}from"./jsonUtils-Cc67rW5Z.js";import{i as xe}from"./sublayerUtils-B8JaGme3.js";import{l as Se,m as Fe}from"./typeUtils-mxDsOnhk.js";import{u as Pe}from"./Layer--GugXUPW.js";import D from"./Graphic-q_7OAYHf.js";import{u as L}from"./SimpleMarkerSymbol-Drowg4jp.js";import{n as Ve,p as _e}from"./popupUtils-DzrmKBBc.js";function et(a){if(!a)return[];let e=ue(a)?[a]:H.isCollection(a)?a.toArray():Array.isArray(a)?a:[];return e=e==null?void 0:e.filter(Q),((e==null?void 0:e.length)??0)===0?[]:e}function $e(a,e){const{dpi:i,gdbVersion:r,geometry:t,geometryPrecision:s,height:d,historicMoment:o,layerOption:y,mapExtent:c,maxAllowableOffset:l,returnFieldName:h,returnGeometry:u,returnUnformattedValues:b,returnZ:F,spatialReference:P,timeExtent:m,tolerance:_,width:v}=a.toJSON(),{dynamicLayers:g,layerDefs:x,layerIds:j}=Oe(a),O=(e==null?void 0:e.geometry)!=null?e.geometry:null,w={historicMoment:o,geometryPrecision:s,maxAllowableOffset:l,returnFieldName:h,returnGeometry:u,returnUnformattedValues:b,returnZ:F,tolerance:_},S=(O==null?void 0:O.toJSON())||t;w.imageDisplay=`${v},${d},${i}`,r&&(w.gdbVersion=r),S&&(delete S.spatialReference,w.geometry=JSON.stringify(S),w.geometryType=we(S));const E=P??(S==null?void 0:S.spatialReference)??(c==null?void 0:c.spatialReference);if(E&&(w.sr=K(E)),w.time=m?[m.start,m.end].join(","):null,c){const{xmin:R,ymin:Z,xmax:C,ymax:W}=c;w.mapExtent=`${R},${Z},${C},${W}`}return x&&(w.layerDefs=x),g&&!x&&(w.dynamicLayers=g),w.layers=y==="popup"?"visible":y,j&&!g&&(w.layers+=`:${j.join(",")}`),w}function Oe(a){var F,P;const{mapExtent:e,floors:i,width:r,sublayers:t,layerIds:s,layerOption:d,gdbVersion:o}=a,y=(P=(F=t==null?void 0:t.find(m=>m.layer!=null))==null?void 0:F.layer)==null?void 0:P.serviceSublayers,c=d==="popup",l={},h=he({extent:e,width:r,spatialReference:e==null?void 0:e.spatialReference}),u=[],b=m=>{const _=h===0,v=m.minScale===0||h<=m.minScale,g=m.maxScale===0||h>=m.maxScale;if(m.visible&&(_||v&&g))if(m.sublayers)m.sublayers.forEach(b);else{if((s==null?void 0:s.includes(m.id))===!1||c&&(!m.popupTemplate||!m.popupEnabled))return;u.unshift(m)}};if(t==null||t.forEach(b),t&&!u.length)l.layerIds=[];else{const m=xe(u,y,o),_=u.map(v=>{const g=T(i,v);return v.toExportImageJSON(g)});if(m)l.dynamicLayers=JSON.stringify(_);else{if(t){let g=u.map(({id:x})=>x);s&&(g=g.filter(x=>s.includes(x))),l.layerIds=g}else s!=null&&s.length&&(l.layerIds=s);const v=je(i,u);if(v!=null&&v.length){const g={};for(const x of v)x.definitionExpression&&(g[x.id]=x.definitionExpression);Object.keys(g).length&&(l.layerDefs=JSON.stringify(g))}}}return l}function je(a,e){const i=!!(a!=null&&a.length),r=e.filter(t=>t.definitionExpression!=null||i&&t.floorInfo!=null);return r.length?r.map(t=>{const s=T(a,t),d=q(s,t.definitionExpression);return{id:t.id,definitionExpression:d??void 0}}):null}var N;let f=N=class extends B{static from(a){return X(N,a)}constructor(a){super(a),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.historicMoment=null,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}writeHistoricMoment(a,e){e.historicMoment=a&&a.getTime()}};n([p({type:Number,json:{write:!0}})],f.prototype,"dpi",void 0),n([p()],f.prototype,"floors",void 0),n([p({type:String,json:{write:!0}})],f.prototype,"gdbVersion",void 0),n([p({types:Se,json:{read:ve,write:!0}})],f.prototype,"geometry",void 0),n([p({type:Number,json:{write:!0}})],f.prototype,"geometryPrecision",void 0),n([p({type:Number,json:{write:!0}})],f.prototype,"height",void 0),n([p({type:Date})],f.prototype,"historicMoment",void 0),n([J("historicMoment")],f.prototype,"writeHistoricMoment",null),n([p({type:[Number],json:{write:!0}})],f.prototype,"layerIds",void 0),n([p({type:["top","visible","all","popup"],json:{write:!0}})],f.prototype,"layerOption",void 0),n([p({type:z,json:{write:!0}})],f.prototype,"mapExtent",void 0),n([p({type:Number,json:{write:!0}})],f.prototype,"maxAllowableOffset",void 0),n([p({type:Boolean,json:{write:!0}})],f.prototype,"returnFieldName",void 0),n([p({type:Boolean,json:{write:!0}})],f.prototype,"returnGeometry",void 0),n([p({type:Boolean,json:{write:!0}})],f.prototype,"returnM",void 0),n([p({type:Boolean,json:{write:!0}})],f.prototype,"returnUnformattedValues",void 0),n([p({type:Boolean,json:{write:!0}})],f.prototype,"returnZ",void 0),n([p({type:Y,json:{write:!0}})],f.prototype,"spatialReference",void 0),n([p({type:H})],f.prototype,"sublayers",void 0),n([p({type:Pe,json:{write:!0}})],f.prototype,"timeExtent",void 0),n([p({type:Number,json:{write:!0}})],f.prototype,"tolerance",void 0),n([p({type:Number,json:{write:!0}})],f.prototype,"width",void 0),f=N=n([I("esri.rest.support.IdentifyParameters")],f);const k=f;let V=class extends B{constructor(a){super(a),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(a,e){return D.fromJSON({attributes:{...e.attributes},geometry:{...e.geometry}})}writeFeature(a,e){if(!a)return;const{attributes:i,geometry:r}=a;i&&(e.attributes={...i}),r!=null&&(e.geometry=r.toJSON(),e.geometryType=Fe.toJSON(r.type))}};n([p({type:String,json:{write:!0}})],V.prototype,"displayFieldName",void 0),n([p({type:D})],V.prototype,"feature",void 0),n([ee("feature",["attributes","geometry"])],V.prototype,"readFeature",null),n([J("feature")],V.prototype,"writeFeature",null),n([p({type:Number,json:{write:!0}})],V.prototype,"layerId",void 0),n([p({type:String,json:{write:!0}})],V.prototype,"layerName",void 0),V=n([I("esri.rest.support.IdentifyResult")],V);const Ee=V;async function Re(a,e,i){const r=(e=Ne(e)).geometry?[e.geometry]:[],t=me(a);return t.path+="/identify",fe(r).then(s=>{const d=$e(e,{geometry:s==null?void 0:s[0]}),o=ge({...t.query,f:"json",...d}),y=be(o,i);return te(t.path,y).then(Ge).then(c=>Ie(c,e.sublayers))})}function Ge(a){const e=a.data;return e.results=e.results||[],e.exceededTransferLimit=!!e.exceededTransferLimit,e.results=e.results.map(i=>Ee.fromJSON(i)),e}function Ne(a){return a=k.from(a)}function Ie(a,e){if(!(e!=null&&e.length))return a;const i=new Map;function r(t){i.set(t.id,t),t.sublayers&&t.sublayers.forEach(r)}e.forEach(r);for(const t of a.results)t.feature.sourceLayer=i.get(t.layerId);return a}let G=null;function tt(a,e){return e.type==="tile"||e.type==="map-image"}let $=class extends re{constructor(e){super(e),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=ie(async i=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(i).catch(()=>{}))})}initialize(){const e=i=>{var r;for(const t of i){const{sourceLayer:s}=t;s!=null&&"geometryType"in s&&s.geometryType==="point"&&t.visible&&(t.visible=!1,(r=this.highlightGraphicUpdated)==null||r.call(this,{graphic:t,property:"visible",oldValue:!0,newValue:!1}))}this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(i).catch(()=>{})),this.updateHighlightedFeatures(this._highlightGeometriesResolution)};this.addHandles([oe(()=>this.highlightGraphics,"change",i=>e(i.added),{onListenerAdd:i=>e(i)})])}async fetchPopupFeaturesAtLocation(e,i){var o,y;const{layerView:{layer:r,view:{scale:t}}}=this;if(!e)throw new A("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:r});const s=Te(r.sublayers,t,i);if(!s.length)return[];const d=await Me(r,s);if(!((((y=(o=r.capabilities)==null?void 0:o.operations)==null?void 0:y.supportsIdentify)??!0)&&r.version>=10.5)&&!d)throw new A("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:r});return d?this._fetchPopupFeaturesUsingQueries(e,s,i):this._fetchPopupFeaturesUsingIdentify(e,s,i)}clearHighlights(){var e;(e=this.highlightGraphics)==null||e.removeAll()}async _updateHighlightedFeaturesSymbols(e){for(const i of e)this._updateSymbology(i)}_updateSymbology(e){var i;if(((i=e.geometry)==null?void 0:i.type)==="point")return this._updatePointSymbology(e)}_setGraphicSymbol(e,i){var t;if(!i)return;const r=e.symbol;e.symbol=i,(t=this.highlightGraphicUpdated)==null||t.call(this,{graphic:e,property:"symbol",oldValue:r,newValue:i})}_updatePointSymbology(e){const i=e.sourceLayer&&"renderer"in e.sourceLayer&&e.sourceLayer.renderer,{highlightGraphicUpdated:r,highlightGraphics:t,layerView:{view:s}}=this,d=o=>{o.visible||(o.visible=!0,r==null||r({graphic:o,property:"visible",oldValue:!1,newValue:!0}))};i&&"getSymbolAsync"in i?i.getSymbolAsync(e).then(async o=>{var l;o||(o=new L);let y=null;const c="visualVariables"in i?(l=i.visualVariables)==null?void 0:l.find(h=>h.type==="size"):void 0;c&&(G||(G=(await ce(async()=>{const{getSize:h}=await import("./visualVariableUtils-DciVTowe.js").then(u=>u.b);return{getSize:h}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]))).getSize),y=G(c,e,{view:s.type,scale:s.scale,shape:o.type==="simple-marker"?o.style:null})),y||(y="width"in o&&"height"in o&&o.width!=null&&o.height!=null?Math.max(o.width,o.height):"size"in o?o.size:16),t!=null&&t.includes(e)&&(this._setGraphicSymbol(e,new L({style:"square",size:y,color:new se([255,255,255,1/255]),xoffset:"xoffset"in o?o.xoffset:0,yoffset:"yoffset"in o?o.yoffset:0})),d(e))}):d(e)}async _updateHighlightedFeaturesGeometries(e){const{layerView:{layer:i,view:r},highlightGraphics:t,highlightGraphicUpdated:s}=this;if(this._highlightGeometriesResolution=e,!s||!(t!=null&&t.length)||!i.capabilities.operations.supportsQuery)return;const d=this._getTargetResolution(e),o=new Map;for(const l of t)if(!this._featuresResolutions.has(l)||this._featuresResolutions.get(l)>d){const h=l.sourceLayer;ae(o,h,()=>new Map).set(l.getObjectId(),l)}const y=Array.from(o,([l,h])=>{const u=l.createQuery();return u.objectIds=[...h.keys()],u.outFields=[l.objectIdField],u.returnGeometry=!0,u.maxAllowableOffset=d,u.outSpatialReference=r.spatialReference,l.queryFeatures(u)}),c=await Promise.all(y);if(!this.destroyed)for(const{features:l}of c)for(const h of l){const u=h.sourceLayer,b=o.get(u).get(h.getObjectId());if(b&&t.includes(b)){const F=b.geometry;b.geometry=h.geometry,s({graphic:b,property:"geometry",oldValue:F,newValue:b.geometry}),this._featuresResolutions.set(b,d)}}}_getTargetResolution(e){const i=e*ne(this.layerView.view.spatialReference),r=i/16;return r<=10?0:e/i*r}async _fetchPopupFeaturesUsingIdentify(e,i,r){const t=await this._createIdentifyParameters(e,i,r);if(t==null)return[];const{results:s}=await Re(this.layerView.layer.parsedUrl,t,r);return s.map(d=>d.feature)}async _createIdentifyParameters(e,i,r){const{floors:t,layer:s,timeExtent:d,view:{spatialReference:o,scale:y}}=this.layerView;if(!i.length)return null;await Promise.all(i.map(({sublayer:F})=>F.load(r).catch(()=>{})));const c=Math.min(le("mapservice-popup-identify-max-tolerance"),s.allSublayers.reduce((F,P)=>P.renderer?U({renderer:P.renderer,pointerType:r==null?void 0:r.pointerType}):F,2)),l=this.createFetchPopupFeaturesQueryGeometry(e,c),h=de(y,o),u=Math.round(l.width/h),b=new z({xmin:l.center.x-h*u,ymin:l.center.y-h*u,xmax:l.center.x+h*u,ymax:l.center.y+h*u,spatialReference:l.spatialReference});return new k({floors:t,gdbVersion:"gdbVersion"in s?s.gdbVersion:void 0,geometry:e,height:u,layerOption:"popup",mapExtent:b,returnGeometry:!0,spatialReference:o,sublayers:s.sublayers,timeExtent:d,tolerance:c,width:u})}async _fetchPopupFeaturesUsingQueries(e,i,r){const{layerView:{floors:t,timeExtent:s}}=this,d=i.map(async({sublayer:o,popupTemplate:y})=>{var j,O,w;if(await o.load(r).catch(()=>{}),o.capabilities&&!o.capabilities.operations.supportsQuery)return[];const c=o.createQuery(),l=U({renderer:o.renderer,pointerType:r==null?void 0:r.pointerType}),h=this.createFetchPopupFeaturesQueryGeometry(e,l),u=new Set,[b]=await Promise.all([Ve(o,y),(j=o.renderer)==null?void 0:j.collectRequiredFields(u,o.fieldsIndex)]);M(r),pe(u,o.fieldsIndex,b);const F=Array.from(u).sort();c.geometry=h,c.outFields=F,c.timeExtent=s;const P=T(t,o);if(c.where=q(c.where,P),((O=o.capabilities)==null?void 0:O.query.supportsOrderBy)&&((w=o.orderBy)==null?void 0:w[0])){const S=o.orderBy[0],E=!S.valueExpression&&S.field,R=S.order==="ascending"?"asc":"desc";E&&(c.orderByFields=[`${E} ${R}`])}const m=this._getTargetResolution(h.width/l),_=await Ae(y);M(r);const v=o.geometryType==="point"||_&&_.arcadeUtils.hasGeometryOperations(y);v||(c.maxAllowableOffset=m);let{features:g}=await o.queryFeatures(c,r);const x=v?0:m;g=await Ue(o,g,r);for(const S of g)this._featuresResolutions.set(S,x);return g});return(await Promise.allSettled(d)).reduce((o,y)=>y.status==="fulfilled"?[...o,...y.value]:o,[]).filter(Q)}};function Te(a,e,i){const r=[];if(!a)return r;const t=s=>{const d=s.minScale===0||e<=s.minScale,o=s.maxScale===0||e>=s.maxScale;if(s.visible&&d&&o){if(s.sublayers)s.sublayers.forEach(t);else if(s.popupEnabled){const y=_e(s,{...i,defaultPopupTemplateEnabled:!1});y!=null&&r.unshift({sublayer:s,popupTemplate:y})}}};return a.map(t),r}function Ae(a){var e;return(e=a.expressionInfos)!=null&&e.length||Array.isArray(a.content)&&a.content.some(i=>i.type==="expression")?ye():Promise.resolve()}async function Me(a,e){var i,r;if((r=(i=a.capabilities)==null?void 0:i.operations)!=null&&r.supportsQuery)return!0;try{return await Promise.any(e.map(({sublayer:t})=>t.load().then(()=>t.capabilities.operations.supportsQuery)))}catch{return!1}}async function Ue(a,e,i){const r=a.renderer;return r&&"defaultSymbol"in r&&!r.defaultSymbol&&(e=r.valueExpression?await Promise.all(e.map(t=>r.getSymbolAsync(t,i).then(s=>s?t:null))).then(t=>t.filter(s=>s!=null)):e.filter(t=>r.getSymbol(t)!=null)),e}n([p({constructOnly:!0})],$.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),n([p({constructOnly:!0})],$.prototype,"layerView",void 0),n([p({constructOnly:!0})],$.prototype,"highlightGraphics",void 0),n([p({constructOnly:!0})],$.prototype,"highlightGraphicUpdated",void 0),n([p({constructOnly:!0})],$.prototype,"updatingHandles",void 0),$=n([I("esri.views.layers.support.MapServiceLayerViewHelper")],$);export{$ as P,tt as _,et as i};
