const m=-3;var o;(function(c){c[c.ALL=0]="ALL",c[c.SOME=1]="SOME"})(o||(o={}));class b{get size(){return this._size}constructor(e=10485760){this._maxSize=e,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._users=new Map,this._sizeLimits=new Map}destroy(){this.clearAll(),this._sizeLimits.clear(),this._users.clear()}register(e){this._users.set(e.id.slice(0,-1),e)}deregister(e){this.clear(e),this._sizeLimits.delete(e),this._users.delete(e.id.slice(0,-1))}get maxSize(){return this._maxSize}set maxSize(e){this._maxSize=Math.max(e,-1),this._checkSize()}getSize(e,s){const t=this._db.get(e.id+s);return(t==null?void 0:t.size)??0}put(e,s,t,h,n){s=e.id+s;const i=this._db.get(s);if(i&&(this._size-=i.size,e.size-=i.size,this._db.delete(s),i.entry!==t&&this._notifyRemove(s,i.entry,i.size,o.ALL)),h>this._maxSize)return void this._notifyRemove(s,t,h,o.ALL);if(t===void 0)return void console.warn("Refusing to cache undefined entry ");if(!h||h<0)return console.warn(`Refusing to cache entry with size ${h} for key ${s}`),void this._notifyRemove(s,t,0,o.ALL);const r=1+Math.max(n,-4)- -3;this._db.set(s,new u(t,h,r)),this._size+=h,e.size+=h,this._checkSize()}updateSize(e,s,t,h){s=e.id+s;const n=this._db.get(s);if(n&&n.entry===t){for(this._size-=n.size,e.size-=n.size;h>this._maxSize;){const i=this._notifyRemove(s,t,h,o.SOME);if(!(i!=null&&i>0))return void this._db.delete(s);h=i}n.size=h,this._size+=h,e.size+=h,this._checkSize()}}pop(e,s){s=e.id+s;const t=this._db.get(s);if(t)return this._size-=t.size,e.size-=t.size,this._db.delete(s),++this._hit,t.entry;++this._miss}get(e,s){s=e.id+s;const t=this._db.get(s);if(t!==void 0)return this._db.delete(s),t.lives=t.lifetime,this._db.set(s,t),++this._hit,t.entry;++this._miss}peek(e,s){const t=this._db.get(e.id+s);return t?++this._hit:++this._miss,t==null?void 0:t.entry}get performanceInfo(){const e={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},s={},t=new Array;this._db.forEach((i,r)=>{const _=i.lifetime;t[_]=(t[_]||0)+i.size,this._users.forEach(d=>{const{id:f,name:a}=d;if(r.startsWith(f)){const l=s[a]||0;s[a]=l+i.size}})});const h={};this._users.forEach(i=>{const r=i.name;if("hitRate"in i&&typeof i.hitRate=="number"&&!isNaN(i.hitRate)&&i.hitRate>0){const _=s[r]||0;s[r]=_,h[r]=Math.round(100*i.hitRate)+"%"}else h[r]="0%"});const n=Object.keys(s);n.sort((i,r)=>s[r]-s[i]),n.forEach(i=>e[i]=Math.round(s[i]/2**20)+"MB / "+h[i]);for(let i=t.length-1;i>=0;--i){const r=t[i];r&&(e["Priority "+(i+-3-1)]=Math.round(r/this._size*100)+"%")}return e}resetStats(){this._hit=this._miss=0,this._users.forEach(e=>e.resetHitRate())}clear(e){const s=e.id;this._db.forEach((t,h)=>{h.startsWith(s)&&(this._size-=t.size,this._db.delete(h),this._notifyRemove(h,t.entry,t.size,o.ALL))}),e.size=0}clearAll(){this._db.forEach((e,s)=>this._notifyRemove(s,e.entry,e.size,o.ALL)),this._users.forEach(e=>e.size=0),this._size=0,this._db.clear()}*values(e){for(const[s,t]of this._db)s.startsWith(e.id)&&(yield t.entry)}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(e,s,t,h){var r;const n=(r=this._users.get(e.split(z)[0]))==null?void 0:r.removeFunc,i=n==null?void 0:n(s,h,t);return typeof i=="number"?i:null}_checkSize(){this._sizeLimits.forEach((e,s)=>this._checkSizeLimits(e,s)),this._checkSizeLimits(this.maxSize)}setMaxSize(e,s){s==null||s<=0?this._sizeLimits.delete(e):this._sizeLimits.set(e,s)}_checkSizeLimits(e,s){const t=s??this;if(t.size<=e)return;const h=s==null?void 0:s.id;let n=!0;for(;n;){n=!1;for(const[i,r]of this._db)if(r.lifetime===0&&(!h||i.startsWith(h))){const _=s??this._users.get(i.split(z)[0]);if(this._purgeItem(i,r,_),t.size<=.9*e)return;n||(n=this._db.has(i))}}for(const[i,r]of this._db)if(!h||i.startsWith(h)){const _=s??this._users.get(i.split(z)[0]);if(this._purgeItem(i,r,_),t.size<=.9*e)return}}_purgeItem(e,s,t){if(this._db.delete(e),s.lives<=1){this._size-=s.size,t&&(t.size-=s.size);const h=this._notifyRemove(e,s.entry,s.size,o.SOME);h!=null&&h>0&&(this._size+=h,t&&(t.size+=h),s.lives=s.lifetime,s.size=h,this._db.set(e,s))}else--s.lives,this._db.set(e,s)}}class u{constructor(e,s,t){this.entry=e,this.size=s,this.lifetime=t,this.lives=t}}const z=":";export{b as h,m as t};
