const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/lclayout-BKmmdaIb.js","assets/_commonjsHelpers-DCkdB7M8.js"])))=>i.map(i=>d[i]);
import{al as ht,H as ft,aN as X,s as ee,cV as Nt,a5 as gt,x as $t,i as bt,aB as Lt,bW as ie,a3 as Ee,X as Tt,c as h,m as f,d as xe,aS as qe,a1 as St,a0 as Mt,n as B,ab as vt,br as Dt}from"./Identifiable-B58w9FD1.js";import"./aaBoundingBox-CGMzNzJN.js";import{e as Rt,s as Pe}from"./OptimizedFeature-DFf7-Rrh.js";import{i as Oe,r as Ct,a as Fe,b as le,l as kt}from"./knowledgeGraphService-BZ-ys-cY.js";import{z as Ge,s as At,c as xt}from"./fieldUtils-5LubkA3t.js";import{Q as De,O as Ie}from"./projectionUtils-DsK_8mH5.js";import{I as _e,t as Ne,_ as Y,E as fe,S as je,o as Re}from"./constants-B4mRqufT.js";import{f as Ot}from"./jsonUtils-rvWrjUVI.js";import{u as Ft}from"./featureConversionUtils-De1fR0uF.js";import"./Graphic-sBrqQAPW.js";import"./GraphicsLayer-DiGOhhuQ.js";import{_ as jt}from"./index-VFfT8Aji.js";import{s as oe}from"./GraphQueryStreaming-C2UEcbT-.js";import{n as qt}from"./typeUtils-Du36Z1Jr.js";import"./SimpleMarkerSymbol-B18xir4G.js";import{g as ge}from"./TextSymbol-C7i9ol-5.js";import{R as pe}from"./Query-B1Zd9wiX.js";import{q as Pt}from"./PopupTemplate-D_WeQBNh.js";import{S as Gt}from"./MultiOriginJSONSupport-BZVrWF1x.js";import{E as Ut}from"./workers-BRuHQO5o.js";import{y as ye}from"./typeUtils-BD6Rtzmx.js";import{h as Ht}from"./Layer-C63inyUN.js";import{f as zt}from"./FeatureStore-BIcyufLs.js";import{L as Bt}from"./QueryEngine-BKgK64dC.js";import{y as Qt,u as Ue}from"./clientSideDefaults-Dv0OPba4.js";import{s as Vt}from"./fieldProperties-BS1_JFoa.js";import{A as de,e as be,l as Wt}from"./labelingInfo-D218ARvW.js";import{p as Jt,n as Yt,l as Zt}from"./BlendLayer-ZjS29wea.js";import{a as Kt,p as Xt,l as er}from"./DisplayFilteredLayer-hz3j_o46.js";import{c as tr,p as rr}from"./FeatureEffectLayer-DTQSrZtt.js";import{d as nr,p as ir}from"./FeatureReductionLayer-1787HCPR.js";import{p as ar,c as or}from"./OrderedLayer-Dqu_ALs4.js";import{f as sr}from"./RefreshableLayer-Dv7Ig4sw.js";import{t as lr}from"./ScaleRangeLayer-Ci7jgVw5.js";import{c as pr,f as ur}from"./TemporalLayer-D2ke8r53.js";import{d as dr,v as cr,j as yr,w as mr,l as hr}from"./OperationalLayer-CKgNO0NN.js";import{m as we}from"./Field-BoWr0HZE.js";import{u as fr}from"./TimeInfo-YCUOEfwp.js";import{m as gr}from"./SimpleRenderer-Cedg0Xn2.js";import{t as He}from"./jsonUtils-DGQt529R.js";import{m as br}from"./typeUtils-CN-pQyH0.js";import{g as Tr}from"./FeatureSet-DrLo5FjM.js";import{p as wr}from"./popupUtils-XSnIyd1l.js";import{L as ze}from"./utils-VkC7NvOP.js";let Ir=class{constructor(){this.version="",this.queryResult=new Er}},Er=class{constructor(){this.featureResult=new _r}},_r=class{constructor(){this.objectIdFieldName="",this.uniqueIdField=new Nr,this.globalIdFieldName="",this.geohashFieldName="",this.geometryProperties=new $r,this.geometryType=null,this.spatialReference=new ht,this.exceededTransferLimit=!1,this.hasZ=!1,this.hasM=!1,this.transform=new wt,this.fields=[],this.fieldNameToAttributeIndexMap={},this.values=[],this.features=[],this.geometryFields=[]}},Nr=class{constructor(){this.name="",this.isSystemMaintained=!1}},$r=class{constructor(){this.shapeAreaFieldName="",this.shapeLengthFieldName="",this.units=""}},wt=class{constructor(){this.quantizeOriginPosition="upperLeft",this.scale=new Lr,this.translate=new Sr}};class Lr{constructor(){this.xScale=0,this.yScale=0,this.mScale=0,this.zScale=0}}let Sr=class{constructor(){this.xTranslate=0,this.yTranslate=0,this.mTranslate=0,this.zTranslate=0}},Mr=class{constructor(){this.name="",this.fieldType="esriFieldTypeString",this.alias="",this.sqlType="sqlTypeVarchar",this.domain="",this.defaultValue=""}},vr=class{constructor(){this.attributes=[],this.compressedGeometry=new Ce,this.centroid=new Ce,this.aggregateGeometries=[]}},Ce=class{constructor(){this.geometryType=null,this.lengths=[],this.coords=[]}};var ce;(function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"})(ce||(ce={}));const Dr=[ce.ELEMENTUID,ce.TYPENAME];var Be,Qe;(function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"})(Be||(Be={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(Qe||(Qe={}));var Ve,ke,Ae,ue;(function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"})(Ve||(Ve={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(ke||(ke={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(Ae||(Ae={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(ue||(ue={}));function Rr(e){const t=new Ir;t.version=e.version;const n=e.get_query_result();if(n.results_type.value!==0)throw new Error("Got a non-feature collection type");const r=n.get_feature_result(),i=t.queryResult.featureResult;i.objectIdFieldName=r.objectid_field_name,i.exceededTransferLimit=r.exceeded_transfer_limit,i.hasM=r.has_m,i.hasZ=r.has_z,i.geometryType=Oe[r.geometry_type.value],i.globalIdFieldName=r.globalid_field_name,i.geohashFieldName=r.geohash_field_name;const a=i.uniqueIdField,o=r.unique_id_field;a.name=o.name,a.isSystemMaintained=o.isSystemMaintained;const s=i.geometryProperties,l=r.geometry_properties;s.shapeAreaFieldName=l.shapeAreaFieldName,s.shapeLengthFieldName=l.shapeLengthFieldName,s.units=l.units;const u=i.spatialReference,c=r.spatial_reference;u.wkid=c.wkid,u.latestWkid=c.latestWkid,u.vcsWkid=c.vcsWkid,u.latestVcsWkid=c.latestVcsWkid,u.wkt=c.wkt,i.transform=kr(r.transform);const p=i.fields,d=i.fieldNameToAttributeIndexMap,y=r.fields,w=y.size();for(let N=0;N<w;N++){const $=y.get(N),S=It($);p.push(S),d[S.name]=N,$.delete()}y.delete();const M=i.values,x=r.values_count();for(let N=0;N<x;N++)M.push(r.get_value_at(N));const m=i.features,E=r.features,k=E.size();if(k>0){for(const N of Dr)if(d[N]===void 0)throw new Error(`Feature collection missing required attribute: ${N}`)}for(let N=0;N<k;N++){const $=new vr,S=E.get(N),G=$.attributes,O=S.attributes_count();for(let _=0;_<O;_++)G.push(S.get_attribute_at(_));const U=S.get_compressed_geometry();U&&($.compressedGeometry=Se(U),$.centroid=Se(S.get_centroid()));const V=$.aggregateGeometries,q=S.aggregate_geometries,K=q.size();for(let _=0;_<K;_++){const T=q.get(_),D=Se(T);V.push(D),T.delete()}q.delete(),m.push($),S.delete()}E.delete();const P=i.geometryFields,j=r.geometry_fields,v=j.size();for(let N=0;N<v;N++){const $=j.get(N),S=Cr($);P.push(S),$.delete()}return j.delete(),t}function Se(e){const t=new Ce;t.geometryType=Oe[e.geometry_type.value];const n=[],r=[];for(let i=0;i<e.lengths.length;i++)n.push(e.lengths[i]);for(let i=0;i<e.coords.length;i++)r.push(e.coords[i]);return t.lengths=n,t.coords=r,t}function It(e){const t=new Mr;return t.name=e.name,t.alias=e.alias,t.fieldType=Ct[e.field_type.value],t.sqlType=Ae[e.sql_type.value],t.domain=e.domain,t.defaultValue=e.default_value,t}function Cr(e){const t=It(e);return t.geometryType=Oe[e.geometry_type.value],t}function kr(e){const t=new wt;t.quantizeOriginPosition=ke[e.quantizeOriginPosition.value];const n=t.scale,r=e.scale;n.xScale=r.xScale,n.yScale=r.yScale,n.mScale=r.mScale,n.zScale=r.zScale;const i=t.translate,a=e.translate;return i.xTranslate=a.xTranslate,i.yTranslate=a.yTranslate,i.mTranslate=a.mTranslate,i.zTranslate=a.zTranslate,t}async function Ar(e){const t=[],n={generateAllSublayers:!1,namedTypeDefinitions:new Map};return e.entitiesUrl&&t.push(We(e.entitiesUrl).then(r=>{Je(r,n)})),e.relationshipsUrl&&t.push(We(e.relationshipsUrl).then(r=>{Je(r,n)})),await Promise.all(t),n}async function ri(e,t){t??(t=!1);const n={generateAllSublayers:t,namedTypeDefinitions:new Map};return await Fr(e).then(r=>{qr(r,n)}),n}async function ni(e){const t=await Fe(),n=new t.MapOfObjectIdentifierSets;xr(n,t,e);const r=new t.MapOfObjectIdentifierSetsEncoder;try{r.set_map_of_identifier_sets(n),r.encode();const i=r.get_encoding_result();if(i.error.error_code!==0)throw new ee("knowledge-graph:layer-support-utils",i.error.error_message);const a=structuredClone(i.get_byte_buffer());return r.delete(),a}finally{n.delete()}}function xr(e,t,n){for(const[r,i]of n.namedTypeDefinitions){if(!i.members||i.useAllData)continue;const a=i.members.keys();let o=!1,s=!0;const l=new t.ObjectIdArray,u=new t.StringArray,c=new t.GlobalIdArray,p=new t.IdentifierArray,d=new t.ObjectIdentifierSet;for(const y of a)s&&(o=!isNaN(Number(y)),s=!1),o?l.add_objectid(Number(y)):(u.add_string(y),c.add_globalid(y)),p.add_identifier(y);d.set_oid_array(l),d.set_string_array(u),d.set_globalid_array(c),d.set_identifier_array(p),l.delete(),u.delete(),c.delete(),p.delete(),e.put_identifier_set(r,d),d.delete()}return e}async function We(e){const t=await ft(e,{responseType:"array-buffer"});return Or(await t.data)}async function Or(e){const t=new(await Fe()).FeatureCollectionDecoder,n=t.decode(new Uint8Array(e));if(n.error_code!==0)throw new ee("knowledge-graph:layer-support-utils",n.error_message);const r=t.get_feature_collection(),i=Rr(r);return t.delete(),i}async function Fr(e){const t=await ft(e,{responseType:"array-buffer"}),n=await t.data;return jr(new Uint8Array(n))}async function jr(e){const t=new(await Fe()).MapOfObjectIdentifierSetsDecoder,n=t.decode(new Uint8Array(e)),r=new Map;if(n.error_code!==0)throw new ee("knowledge-graph:layer-support-utils",n.error_message);const i=t.get_map_of_identifier_sets(),a=i.keys,o=a.size();for(let s=0;s<o;s++){const l=a.get(s),u=i.query_identifier_set(l),c=[];if(u.id_array_type.value===ue.GLOBALID_ARRAY){const p=u.get_globalid_array(),d=p.count();for(let y=0;y<d;y++)c.push(p.get_globalid_at(y))}else if(u.id_array_type.value===ue.IDENTIFIER_ARRAY){const p=u.get_identifier_array(),d=p.count();for(let y=0;y<d;y++)c.push(p.get_identifier_at(y).toString())}else if(u.id_array_type.value===ue.STRING_ARRAY){const p=u.get_string_array(),d=p.count();for(let y=0;y<d;y++)c.push(p.get_string_at(y))}else{if(u.id_array_type.value!==ue.OID_ARRAY)throw new ee("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{const p=u.get_oid_array(),d=p.count();for(let y=0;y<d;y++)c.push(p.get_objectid_at(y).toString())}}r.set(l,c)}return t.delete(),r}function Je(e,t){var r,i,a;if(!((r=e==null?void 0:e.queryResult)!=null&&r.featureResult))return t;const n=e.queryResult.featureResult.fieldNameToAttributeIndexMap;for(const o of e.queryResult.featureResult.features){const s=o.attributes[n[ce.TYPENAME]],l=X(t.namedTypeDefinitions,s,()=>({useAllData:!1,members:new Map})),u=o.attributes[n[ce.ELEMENTUID]];if(((a=(i=o.compressedGeometry)==null?void 0:i.coords)==null?void 0:a.length)>0){let c=o.compressedGeometry.lengths;o.compressedGeometry.geometryType==="esriGeometryPoint"&&(c=[]),l.members.set(u,{id:u,linkChartLocation:new Rt(c,o.compressedGeometry.coords)})}else l.members.set(u,{id:u})}return t}function qr(e,t){for(const[n,r]of e){const i=X(t.namedTypeDefinitions,n,()=>({useAllData:!1,members:new Map}));for(const a of r)i.members.has(a)||i.members.set(a,{id:a})}return t}const ii={fetchAndConvertSerializedLinkChart:e=>Ar(e)};let Me=class se{constructor(){this._featureLookup=new Map}static getInstance(){return se.instance||(se.instance=new se),se.instance}static resetInstance(){se.instance&&(se.instance=null)}deleteFromStore(t){t.forEach(n=>{this._featureLookup.delete(n)})}readFromStoreByList(t){const n=[];return t.forEach(r=>{const i=this.readFromStoreById(r);i&&n.push(i)}),n}readFromStoreById(t){return this._featureLookup.get(t)??null}writeToStore(t,n,r){const i=[];return t.forEach(a=>{if(!(a!=null&&a.id))return;a.properties||(a.properties=[]);let o,s=null;if(r&&a.properties[r]&&(s=Ft(a.properties[r])),"originId"in a&&"destinationId"in a&&(a.properties[_e]=a.originId,a.properties[Ne]=a.destinationId),a.properties[n]=a.id,a.id&&this._featureLookup.has(a.id)&&this._featureLookup.get(a.id).attributes){const l=this._featureLookup.get(a.id),u=JSON.parse(JSON.stringify(Object.assign(l.attributes,a.properties)));r&&a.properties[r]&&(u[r]=Ot(a.properties[r])),o=new Pe(s?JSON.parse(JSON.stringify(s)):l!=null&&l.geometry?JSON.parse(JSON.stringify(l.geometry)):null,u,null,a.properties[n])}else o=new Pe(s?JSON.parse(JSON.stringify(s)):null,a.properties,null,a.properties[n]);this._featureLookup.set(`${a.typeName?`${a.typeName}__${a.id}`:a.id}`,o),i.push(o)}),i}},ve,I=null;function ai(){return ve||(ve=jt(()=>import("./lclayout-BKmmdaIb.js"),__vite__mapDeps([0,1])).then(e=>e.l).then(({default:e})=>e({locateFile:t=>Nt(`esri/libs/linkchartlayout/${t}`)})).then(e=>{Pr(e)}),ve)}function Pr(e){I=e}var Ye,te,Ze,$e;(function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot",e[e.IsOld=8]="IsOld"})(Ye||(Ye={})),function(e){e[e.Success=0]="Success",e[e.Error=1]="Error",e[e.Canceled=2]="Canceled"}(te||(te={})),function(e){e[e.Regular=0]="Regular",e[e.Curved=1]="Curved",e[e.Recursive=2]="Recursive"}(Ze||(Ze={})),function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom"}($e||($e={}));const Ke={none:0,"start-only":1,"start-and-end":2};function Gr(e){const t={timeDirection:"right",timeBannerUTCOffsetInMinutes:0,eventsTicksVisualization:"start-and-end",showDurationLineForNonZeroDurationEntityEvents:!0,durationLineWidth:5,entityPositionAtDurationRatio:1,showNonZeroDurationIntervalBounds:!1,separateTimeOverlaps:!0,separateTimelineOverlaps:!0,moveFirstBends:!0,secondBendRatio:.3,lineSeparationMultiplier:1,spaceSeparatedLinesEvenly:!1,useBezierCurves:!1,separatedLineShapeRatio:0,...(e==null?void 0:e.toJSON())??{},eventsTicksVisualization:(e==null?void 0:e.eventsTicksVisualization)??"start-and-end"};return{...t,timeDirection:{value:$e[t.timeDirection]??$e.right},eventsTicksVisualization:{value:Ke[t.eventsTicksVisualization]??Ke["start-and-end"]}}}function ae(e,t,n,r,i,a){const o=n.length,s=i.length,l=Float64Array.BYTES_PER_ELEMENT,u=Uint32Array.BYTES_PER_ELEMENT,c=Uint8Array.BYTES_PER_ELEMENT,p=16,d=p+o*(c+2*l)+s*(2*u),y=I._malloc(d);try{const w=y+p-y%p,M=w+o*l,x=M+o*l,m=x+s*u,E=m+s*u,k=()=>[I.HEAPF64.subarray(w>>3,(w>>3)+o),I.HEAPF64.subarray(M>>3,(M>>3)+o),I.HEAPU32.subarray(x>>2,(x>>2)+s),I.HEAPU32.subarray(m>>2,(m>>2)+s),I.HEAPU8.subarray(E,E+o)],[P,j,v,N,$]=k();P.set(n),j.set(r),v.set(i),N.set(a),$.set(t);const S=e(o,E,w,M,s,x,m);let G=null,O=null;if(S.value===te.Success){const T=I.getLayoutLinksTypes(),D=I.getLayoutLinksVerticesEndIndices(),A=I.getLayoutLinksVertices(),R=I.countLayoutLinksVertices();!s||T&&D?R&&!A?S.value=te.Error:(G={types:new Uint8Array(I.HEAPU8.subarray(T,T+s)),vertexEndIndex:new Uint32Array(I.HEAPU32.subarray(D>>2,(D>>2)+s)),vertices:new Float64Array(I.HEAPF64.subarray(A>>3,(A>>3)+2*R))},O=I.getAuxiliaryGraphicElements()):S.value=te.Error}const[U,V,q,K,_]=k();return n.set(U),r.set(V),i.set(q),a.set(K),t.set(_),{status:S.value,links:G,graphics:O}}finally{I._free(y),I.cleanupLayout()}}const Xe=2,et=1,tt=-1;var rt,nt,it,at,ot,st,lt,pt,ut;(function(e){function t(){return I.getMinIdealEdgeLength()}function n(r,i,a,o,s,l,u=Xe,c=et,p=tt){return ae((d,y,w,M,x,m,E)=>I.applyForceDirectedLayout(r,d,y,w,M,x,m,E,u,c,p),i,a,o,s,l)}e.getMinIdealEdgeLength=t,e.apply=n})(rt||(rt={})),function(e){function t(n,r,i,a,o,s,l=Xe,u=et,c=tt){return ae((p,d,y,w,M,x,m)=>I.applyCommunityLayout(n,p,d,y,w,M,x,m,l,u,c),r,i,a,o,s)}e.apply=t}(nt||(nt={})),function(e){function t(n,r,i,a,o,s){return ae((l,u,c,p,d,y,w)=>I.applySimpleLayout(n,l,u,c,p,d,y,w),r,i,a,o,s)}e.apply=t}(it||(it={})),function(e){function t(n,r,i,a,o,s){return ae((l,u,c,p,d,y,w)=>I.applyHierarchicalLayout(n,l,u,c,p,d,y,w),r,i,a,o,s)}e.apply=t}(at||(at={})),function(e){function t(n,r,i,a,o,s){return ae((l,u,c,p,d,y,w)=>I.applyRadialTreeLayout(n,l,u,c,p,d,y,w),r,i,a,o,s)}e.apply=t}(ot||(ot={})),function(e){function t(n,r,i,a,o,s){return ae((l,u,c,p,d,y,w)=>I.applySmartTreeLayout(n,l,u,c,p,d,y,w),r,i,a,o,s)}e.apply=t}(st||(st={})),function(e){function t(n,r,i,a,o,s,l,u,c,p,d,y){return ae((w,M,x,m,E,k,P)=>{if(o.length!==w)return{value:te.Error};if(s.length!==w)return{value:te.Error};if(c.length!==E)return{value:te.Error};if(p.length!==E)return{value:te.Error};const j=Float64Array.BYTES_PER_ELEMENT,v=16,N=I._malloc(v+w*j),$=I._malloc(v+w*j),S=I._malloc(v+E*j),G=I._malloc(v+E*j),O=N+v-N%v,U=$+v-$%v,V=S+v-S%v,q=G+v-G%v;try{return I.HEAPF64.subarray(O>>3,(O>>3)+w).set(o),I.HEAPF64.subarray(U>>3,(U>>3)+w).set(s),I.HEAPF64.subarray(V>>3,(V>>3)+E).set(c),I.HEAPF64.subarray(q>>3,(q>>3)+E).set(p),I.applyChronologicalLayout(n,w,M,x,m,O,U,E,k,P,V,q,d,Gr(y))}finally{I._free(N),I._free($),I._free(S),I._free(G)}},r,i,a,l,u)}e.apply=t}(lt||(lt={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(pt||(pt={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(ut||(ut={}));gt()({none:"none",startAndEnd:"start-and-end",startOnly:"start-only"});gt()({absoluteValue:"absolute-value",multiplier:"multiplier"});const Ur=new Map([["basic-grid","basic-grid"],["geographic-organic-standard","geographic-organic-standard"],["hierarchical-bottom-to-top","hierarchical-bottom-to-top"],["hierarchical-top-to-bottom","hierarchical-bottom-to-top"],["organic-community","organic-community"],["organic-fusiform","organic-standard"],["organic-leaf-circle","organic-standard"],["organic-standard","organic-standard"],["radial-node-centric","radial-root-centric"],["radial-root-centric","radial-root-centric"],["tree-bottom-to-top","tree-left-to-right"],["tree-left-to-right","tree-left-to-right"],["tree-right-to-left","tree-left-to-right"],["tree-top-to-bottom","tree-left-to-right"],["chronological-mono-timeline","chronological-mono-timeline"],["chronological-multi-timeline","chronological-multi-timeline"]]);function Hr(e,t){var r,i;const n=new Map;if((r=t.dataModel)!=null&&r.relationshipTypes)for(const a of t.dataModel.relationshipTypes)a.name&&n.set(a.name,[]);for(const a of e)n.has(a.typeName)&&((i=n.get(a.typeName))==null||i.push(a.id));return n}async function oi(e,t,n){const r=[],i=Hr(e,t),a={},o=[];for(const[c,p]of i){if(p.length<1)continue;const d=`${c}_ids`;a[d]=p,o.push(`MATCH (n)-[r:${c}]->(m) WHERE id(r) in $${d} RETURN id(n), labels(n)[0], id(m), labels(m)[0]`)}if(o.length===0)return[];const s=o.join(" UNION "),l=new oe({openCypherQuery:s,bindParameters:a}),u=(await le(t,l,n==null?void 0:n.requestOptions)).resultRowsStream.getReader();for(;;){const{done:c,value:p}=await u.read();if(c)break;for(const d of p)r.push({id:d[0],typeName:d[1]}),r.push({id:d[2],typeName:d[3]})}return r}const si=e=>Ur.get(e)??"radial-root-centric";function zr(e){if(!e.spatialReference.isWGS84)throw new ee("knowledge-graph:layer-support-utils","The utilsExtentToInBoundsRings function only supports WGS84 spatial references.");return e.clone().normalize().map(t=>[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]])}let J=class extends $t{constructor(e){var n,r,i;super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const t=new Map;(n=e.knowledgeGraph.dataModel.entityTypes)==null||n.forEach(a=>{var o,s;a.name&&(t.set(a.name,"entity"),this._processingCacheUpdatesLookup.set(a.name,[]),e.inclusionModeDefinition&&!((o=e.inclusionModeDefinition)!=null&&o.generateAllSublayers)||this.entityTypeNames.add(a.name),(s=a.properties)==null||s.forEach(l=>{l.geometryType&&l.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(a.name,{name:l.name??"",geometryType:l.geometryType})}))}),(r=e.knowledgeGraph.dataModel.relationshipTypes)==null||r.forEach(a=>{var o,s;a.name&&(t.set(a.name,"relationship"),this._processingCacheUpdatesLookup.set(a.name,[]),e.inclusionModeDefinition&&!((o=e.inclusionModeDefinition)!=null&&o.generateAllSublayers)||this.relationshipTypeNames.add(a.name),(s=a.properties)==null||s.forEach(l=>{l.geometryType&&l.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(a.name,{name:l.name??"",geometryType:l.geometryType})}))}),(i=e.inclusionModeDefinition)==null||i.namedTypeDefinitions.forEach((a,o)=>{var l,u;if(t.get(o)==="entity")this.entityTypeNames.add(o);else{if(t.get(o)!=="relationship")return bt.getLogger(this).warn(`A named type, ${o}, was in the inclusion list that wasn't in the data model and will be removed`),void((l=e.inclusionModeDefinition)==null?void 0:l.namedTypeDefinitions.delete(o));this.relationshipTypeNames.add(o)}const s=new Map;(u=a.members)==null||u.forEach(c=>{X(this.memberIdTypeLookup,c.id,()=>new Set).add(o)}),this.sublayerCaches.set(o,s)})}addToLayer(e){e.forEach(({typeName:t,id:n})=>{if(!this.inclusionModeDefinition)throw new ee("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){const r=this.inclusionModeDefinition.namedTypeDefinitions.get(t);r.members||(r.members=new Map),r.members.set(n,{id:n}),X(this.memberIdTypeLookup,n,()=>new Set).add(t)}}else{const r=new Map;r.set(n,{id:n}),this.inclusionModeDefinition.namedTypeDefinitions.set(t,{useAllData:!1,members:r}),X(this.memberIdTypeLookup,n,()=>new Set).add(t)}})}getById(e){return Me.getInstance().readFromStoreById(e)}async getData(e,t,n){var i,a;if(t.objectType.name&&((i=this.inclusionModeDefinition)!=null&&i.namedTypeDefinitions)&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let r;if(r=e||new pe({where:"1=1",outFields:["*"]}),t.parentCompositeLayer.type==="link-chart"){const o=t.parentCompositeLayer,s=this._processingCacheUpdatesLookup.get(t.objectType.name??""),l=r.outFields;l&&l.length===1&&l[0]===Y&&r.where==="1=1"||await Promise.all(s??[]);const u=this.sublayerCaches.has(t.objectType.name??"")?Array.from((a=this.sublayerCaches.get(t.objectType.name))==null?void 0:a.values()):[],c=[];return u.forEach(p=>{if(this.relationshipTypeNames.has(t.objectType.name)){p.geometry=o.relationshipLinkChartDiagramLookup.get(p.attributes[t.objectIdField]);const d=this.memberIdTypeLookup.get(p.attributes[_e]),y=this.memberIdTypeLookup.get(p.attributes[Ne]),w=this._isEndEntitySpatial(d,p,_e),M=this._isEndEntitySpatial(y,p,Ne);p.attributes[fe]=Number(w&&M)}else{p.geometry=o.entityLinkChartDiagramLookup.get(p.attributes[t.objectIdField]);const d=this.geographicLookup.get(t.objectType.name);d&&p.attributes[d.name]?p.attributes[fe]=1:p.attributes[fe]=0}p.attributes[je]=p.geometry,c.push(p)}),c}return this.retrieveDataFromService(r,t,n)}async getConnectedRecordIds(e,t,n){const r=[];let i="";const a=this._getNamedTypeIdMapFromNodeIds(e);if(t&&(t==null?void 0:t.length)!==0){for(const c of t)i=i+c+"|";i=i.slice(0,-1)}const o={},s=[];for(const[c,p]of a){const d=`${c}_ids`;o[d]=p,t&&(t==null?void 0:t.length)!==0?s.push(`MATCH (n:${c}) WHERE id(n) IN $${d} WITH n MATCH (n)-[r:${i}]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`):s.push(`MATCH (n:${c}) WHERE id(n) IN $${d} WITH n MATCH (n)-[r]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`)}if(!s.length)return r;const l=s.join(" UNION "),u=(await le(this.knowledgeGraph,new oe({openCypherQuery:l,bindParameters:o}),{signal:n==null?void 0:n.signal})).resultRowsStream.getReader();for(;;){const{done:c,value:p}=await u.read();if(c)break;for(let d=0;d<p.length;d++){const y=p[d];r.push({id:y[0],typeName:y[1]}),r.push({id:y[2],typeName:y[3]})}}return r}async getRelationshipsBetweenNodes(e,t,n){const r=this._getNamedTypeIdMapFromNodeIds(e);if(r.size===0)return[];const i={relationshipExclusionIds:t,possibleConnectionEntityIds:e},a=[];for(const[u,c]of r.entries()){const p=`${u}_ids`;i[p]=c,a.push(`MATCH (n:${u}) WHERE id(n) IN $${p} WITH n MATCH (n)-[r]->(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const o=a.join(" UNION "),s=[],l=(await le(this.knowledgeGraph,new oe({openCypherQuery:o,bindParameters:i}),{signal:n==null?void 0:n.signal})).resultRowsStream.getReader();for(;;){const{done:u,value:c}=await l.read();if(u)break;for(let p=0;p<c.length;p++){const d=c[p];s.push({id:d[0],typeName:d[1]})}}return s}async getRelationshipsFromNodes(e,t,n,r){const i=this._getNamedTypeIdMapFromNodeIds(e);if(i.size===0||t.length===0)return[];const a={relationshipExclusionIds:n,possibleConnectionEntityIds:t},o=[];for(const[p,d]of i.entries()){const y=`${p}_ids`;a[y]=d,o.push(`MATCH (n:${p}) WHERE id(n) IN $${y} WITH n MATCH (n)-[r]-(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const s=o.join(" UNION "),l=new Map,u=(await le(this.knowledgeGraph,new oe({openCypherQuery:s,bindParameters:a}),{signal:r==null?void 0:r.signal})).resultRowsStream.getReader();for(;;){const{done:p,value:d}=await u.read();if(p)break;for(let y=0;y<d.length;y++){const w=d[y];let M=l.get(w[1]);M||(M=new Set,l.set(w[1],M)),M.add(w[0])}}const c=[];for(const[p,d]of l)for(const y of d)c.push({id:y,typeName:p});return c}async refreshCacheContent(e,t,n,r=!0,i){var u,c,p,d,y,w,M,x;const a=Me.getInstance(),o=[],s=new Map,l=new Map;(u=this.knowledgeGraph.dataModel.entityTypes)==null||u.forEach(m=>{m.name&&l.set(m.name,m)}),(c=this.knowledgeGraph.dataModel.relationshipTypes)==null||c.forEach(m=>{m.name&&l.set(m.name,m)}),e||this.inclusionModeDefinition?e?e.forEach(m=>{var E;if(this.memberIdTypeLookup.has(m))for(const k of this.memberIdTypeLookup.get(m))s.has(k)?(E=s.get(k))==null||E.push(m):s.set(k,[m])}):(d=(p=this.inclusionModeDefinition)==null?void 0:p.namedTypeDefinitions)==null||d.forEach((m,E)=>{m.useAllData?s.set(E,null):m.members&&m.members.forEach(k=>{var P;s.has(E)&&s.get(E)!==null?(P=s.get(E))==null||P.push(k.id):s.set(E,[k.id])})}):((y=this.knowledgeGraph.dataModel.entityTypes)==null||y.forEach(m=>{m.name&&s.set(m.name,null)}),(w=this.knowledgeGraph.dataModel.entityTypes)==null||w.forEach(m=>{m.name&&s.set(m.name,null)}));for(const[m,E]of s){const k=new Set(E),P=new Promise((j,v)=>{(async()=>{var K,_,T,D,A,R,C,F,L;const $=new Set,S=[];let G,O="",U=!1;if(t||((_=(K=l.get(m))==null?void 0:K.properties)==null||_.forEach(g=>{g.name&&$.add(g.name)})),n&&this.geographicLookup.has(m)){const g=(T=this.geographicLookup.get(m))==null?void 0:T.name;g&&$.add(g)}if(this.entityTypeNames.has(m))O=`MATCH (n:${m}) ${E?"WHERE id(n) IN $ids ":""}return ID(n)`,$.forEach(g=>{O+=`, n.${g}`,S.push(g)});else{if(!this.relationshipTypeNames.has(m))throw new ee("knowledge-graph:layer-data-manager",`The graph type of ${m} could not be determined. Was this type set in the KG data model and inclusion definition?`);U=!0,O=`MATCH ()-[n:${m}]->() ${E?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,$.forEach(g=>{O+=`, n.${g}`,S.push(g)})}G=new oe(E?{openCypherQuery:O,bindParameters:{ids:E}}:{openCypherQuery:O});const V=(await le(this.knowledgeGraph,G,{signal:i==null?void 0:i.signal})).resultRowsStream.getReader();for(;;){const{done:g,value:re}=await V.read();if(g)break;const W=[];for(let Z=0;Z<re.length;Z++){const ne=re[Z];let H=0,Te=0;const z={properties:{}};for(z.id=ne[H],H++,Te++,U&&(z.originId=ne[H],H++,Te++,z.destinationId=ne[H],H++,Te++,X(this.nodeConnectionsLookup,z.originId,()=>new Set).add(z.id),X(this.nodeConnectionsLookup,z.destinationId,()=>new Set).add(z.id),X(this.relationshipConnectionsLookup,z.id,()=>[z.originId,z.destinationId]));H<ne.length;H++)z.properties[S[H-Te]]=ne[H];k.delete(z.id),W.push(z)}const _t=a.writeToStore(W,Y,(D=this.geographicLookup.get(m))==null?void 0:D.name);this.sublayerCaches.has(m)||this.sublayerCaches.set(m,new Map),r&&!((A=this.inclusionModeDefinition)!=null&&A.namedTypeDefinitions.has(m))&&((R=this.inclusionModeDefinition)==null||R.namedTypeDefinitions.set(m,{useAllData:!1,members:new Map})),r&&!((C=this.inclusionModeDefinition)!=null&&C.namedTypeDefinitions.get(m).members)&&(this.inclusionModeDefinition.namedTypeDefinitions.get(m).members=new Map);const Le=this.sublayerCaches.get(m);_t.forEach(Z=>{var ne,H;Le==null||Le.set(Z.attributes[Y],Z),r&&!((ne=this.inclusionModeDefinition)!=null&&ne.namedTypeDefinitions.get(m).members.has(Z.attributes[Y]))&&((H=this.inclusionModeDefinition)==null||H.namedTypeDefinitions.get(m).members.set(Z.attributes[Y],{id:Z.attributes[Y]}),X(this.memberIdTypeLookup,Z.attributes[Y],()=>new Set).add(m))})}const q=(F=this.inclusionModeDefinition)==null?void 0:F.namedTypeDefinitions.get(m);if(q)for(const g of k)(L=q.members)==null||L.delete(g)})().then(()=>{j(null)}).catch($=>{$.name==="AbortError"?j(null):v($)})});o.push(P),(M=this._processingCacheUpdatesLookup.get(m))==null||M.push(P)}if(await Promise.all(o),(x=i==null?void 0:i.signal)==null?void 0:x.aborted)throw Lt()}removeFromLayer(e){var r,i,a;const t=new Set,n=new Set(e.map(o=>o.id));for(const o of e)t.add(o.typeName),((r=this.memberIdTypeLookup.get(o.id))==null?void 0:r.size)===1?this.memberIdTypeLookup.delete(o.id):(i=this.memberIdTypeLookup.get(o.id))==null||i.delete(o.typeName),(a=this.inclusionModeDefinition)==null||a.namedTypeDefinitions.forEach((s,l)=>{var u;l===o.typeName&&((u=s.members)!=null&&u.has(o.id))&&s.members.delete(o.id)});t.forEach(o=>{var s;(s=this.sublayerCaches.get(o))==null||s.forEach((l,u)=>{var c;n.has(u)&&((c=this.sublayerCaches.get(o))==null||c.delete(u))})})}async retrieveDataFromService(e,t,n){var w,M,x,m,E,k,P,j,v,N,$,S,G,O,U,V,q,K;const r=Me.getInstance(),i=new Set,a=[];let o,s="",l=[];const u=t.graphType==="relationship",c=(x=(M=(w=this.inclusionModeDefinition)==null?void 0:w.namedTypeDefinitions)==null?void 0:M.get(t.objectType.name))==null?void 0:x.useAllData,p=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);let d=!c&&p?Array.from(p).sort():null;if((k=(E=(m=this.inclusionModeDefinition)==null?void 0:m.namedTypeDefinitions)==null?void 0:E.get(t.objectType.name))!=null&&k.useAllData)(v=(j=(P=this.inclusionModeDefinition)==null?void 0:P.namedTypeDefinitions)==null?void 0:j.get(t.objectType.name))!=null&&v.useAllData&&e.objectIds!=null&&(d=e.objectIds);else if(e.objectIds!=null&&d&&d.length>0){const _=e.objectIds;e.objectIds=d.filter(T=>_.includes(T))}else if(e.objectIds!=null)d=e.objectIds;else{if((N=this.inclusionModeDefinition)!=null&&N.namedTypeDefinitions.has(t.objectType.name)&&(!(($=this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name))!=null&&$.members)||((G=(S=this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name))==null?void 0:S.members)==null?void 0:G.size)<1))return e.objectIds=[],[];e.objectIds=d}if(e.outFields!=null){const _=e.outFields;_.includes("*")?t.fields.forEach(T=>{i.add(T.name)}):_.forEach(T=>{T!==Y&&T!==t.geometryFieldName&&i.add(T)})}if(e.geometry!=null){const _=e.geometry;let T;const D=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,A=D==null?void 0:D.spatialReference,R=(O=D==null?void 0:D.serviceCapabilities)==null?void 0:O.geometryCapabilities;let C=R==null?void 0:R.geometryMaxBoundingRectangleSizeX,F=R==null?void 0:R.geometryMaxBoundingRectangleSizeY;if(_.type==="point"){let L=_;(U=L.spatialReference)!=null&&U.isWGS84||(await De(L.spatialReference,ie),L=Ie(L,ie)),T=new Ee({spatialReference:ie,xmin:L.x-1e-4,ymin:L.y-1e-4,xmax:L.x+1e-4,ymax:L.y+1e-4})}else(V=_==null?void 0:_.extent)!=null&&V.spatialReference&&!((q=_.spatialReference)!=null&&q.isWGS84)?(await De(_.extent.spatialReference,ie),T=Ie(_.extent,ie)):T=_.extent;if(C&&F&&A){if(A.wkid!==4326){const L=new Ee({spatialReference:A,xmax:C,ymax:F}),g=Ie(L,ie);C=g.xmax,F=g.ymax}if(T.xmax-T.xmin>C)throw new ee("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${C}° latitude, limit exceeded`);if(T.ymax-T.ymin>F)throw new ee("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${F}° longitude, limit exceeded`)}if(e.where!=null&&e.where!=="1=1"){const L=await Ge(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach(g=>{L.fieldNames.includes(g.name)&&i.add(g.name)})}s=u?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&i.add(t.geometryFieldName),i.forEach(L=>{s+=`, n.${L}`,a.push(L)}),o=new oe({openCypherQuery:s,bindParameters:{param_filter_geom:new Tt({rings:zr(T)})}})}else{let _="";if(e.where!=null&&e.where!=="1=1"){const A=await Ge(e.where,t.fieldsIndex);t.fields.forEach(g=>{A.fieldNames.includes(g.name)&&i.add(g.name)});const R=new Set(["column-reference","string","number","binary-expression"]),C=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let F=!1;const L=g=>{if(g.type==="column-reference")return`n.${g.column}`;if(g.type==="string")return`'${g.value}'`;if(g.type==="number")return`${g.value}`;if(g.type==="binary-expression"&&R.has(g.left.type)&&R.has(g.right.type)&&C.has(g.operator))return`${L(g.left)} ${g.operator} ${L(g.right)}`;if(g.type==="binary-expression"&&g.operator==="LIKE"){let re="";if(g.left.type==="function"&&g.left.args.value[0].type==="column-reference")re+=`lower(n.${g.left.args.value[0].column})`;else{if(g.left.type!=="column-reference")return F=!0,"";re+=`lower(n.${g.left.column})`}if(re+=" CONTAINS (",g.right.type!=="string")return F=!0,"";{let W=g.right.value;W.charAt(0)==="%"&&(W=W.slice(1)),W.charAt(W.length-1)==="%"&&(W=W.slice(0,-1)),re+=`'${W.toLowerCase()}')`}return re}return F=!0,""};_=L(A.parseTree),F&&(_="")}let T="";T=u?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let D=!1;d&&(D=!0,T+=" WHERE ID(n) IN $ids"),_&&(T+=D?" AND":" WHERE",T+=` ${_}`),T+=" return ID(n)",u&&(T+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&t.geometryFieldName&&i.add(t.geometryFieldName),i.forEach(A=>{T+=`, n.${A}`,a.push(A)}),o=new oe(d?{openCypherQuery:T,bindParameters:{ids:d}}:{openCypherQuery:T})}const y=(await le(t.parentCompositeLayer.dataManager.knowledgeGraph,o,n)).resultRowsStream.getReader();for(;;){const{done:_,value:T}=await y.read();if(_)break;const D=[];for(let A=0;A<T.length;A++){const R=T[A];let C=0,F=0;const L={properties:{}};for(L.id=R[C],C++,F++,u&&(L.originId=R[C],C++,F++,L.destinationId=R[C],C++,F++);C<R.length;C++)L.properties[a[C-F]]=R[C];D.push(L)}l=l.concat(r.writeToStore(D,Y,(K=t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name))==null?void 0:K.name))}return l}_isEndEntitySpatial(e,t,n){var r;for(const i of e??[])if(this.entityTypeNames.has(i)){const a=this.geographicLookup.get(i),o=a&&((r=this.sublayerCaches.get(i))==null?void 0:r.get(t.attributes[n]));if(a&&(o!=null&&o.attributes[a.name]))return!0}return!1}_getNamedTypeIdMapFromNodeIds(e){const t=new Map;return e.forEach(n=>{var r;if(this.memberIdTypeLookup.has(n))for(const i of this.memberIdTypeLookup.get(n)){if(!this.entityTypeNames.has(i))return;t.has(i)?(r=t.get(i))==null||r.push(n):t.set(i,[n])}}),t}};h([f()],J.prototype,"knowledgeGraph",void 0),h([f()],J.prototype,"inclusionModeDefinition",void 0),h([f()],J.prototype,"entityTypeNames",void 0),h([f()],J.prototype,"relationshipTypeNames",void 0),h([f()],J.prototype,"geographicLookup",void 0),h([f()],J.prototype,"sublayerCaches",void 0),h([f()],J.prototype,"nodeConnectionsLookup",void 0),h([f()],J.prototype,"relationshipConnectionsLookup",void 0),h([f()],J.prototype,"memberIdTypeLookup",void 0),J=h([xe("esri.layers.knowledgeGraph.KnowledgeGraphLayerDataManager")],J);const dt=Vt(),Br=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return h([f(dt.fields)],t.prototype,"fields",void 0),h([f(dt.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=h([xe("esri.layers.knowledgeGraph.KnowledgeGraphSublayerBase")],t),t},Qr={initializeLayersFromClientData:async(e,t,n)=>{if(t||(t=[...e.layers,...e.tables].map(a=>a.graphTypeName)),(t==null?void 0:t.length)===0)return;const r=new Map;for(const a of t)r.set(a,ct(e,a));const i=await kt(e.dataManager.knowledgeGraph,Array.from(r.values()),{requestOptions:{signal:n==null?void 0:n.signal}});for(const a of[...e.layers,...e.tables]){const o=a.objectType.name;if(o==null)continue;const s=i.get(ct(e,o));if(s){const l=JSON.parse(s);l===null||typeof l!="object"||l.hasOwnProperty("showLabels")||(l.showLabels=!1),a.read(l,{origin:"service"})}}}},ct=(e,t)=>e.type==="knowledge-graph"?`${t}/Map`:`${t}/LinkChart/LinkChartSubLayer`;async function li(e,t,n){return Qr.initializeLayersFromClientData(e,t,n)}const yt=["#4a0932","#b31515","#18382e","#a64f1b","#102432","#8c213f","#ed9310","#2c6954","#144d59","#ffc730","#75351e","#454f4b","#78b1c2","#191921","#8f8f82","#9be0c0","#dbb658","#87b051","#11495c","#c43541","#9c5596","#44498b","#ad9d63","#86afb3","#5c98ca","#b0bfa2","#73241f","#b86b53","#d9d78c","#3e756d","#f260a1","#a0d17d","#c27c30","#eb82eb","#ffdf3c","#ffb259","#ab52b3","#3cccb4","#0095ba","#d92b30"],Vr="#8f8f82";function Wr(e){return e<0||e>=yt.length?new qe(Vr):new qe(yt[e])}function Jr(e){const t=e.toArray();return new qt({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",enable:!0,style:"solid",width:.75,color:t},{type:"CIMVectorMarker",enable:!0,size:6,markerPlacement:{type:"CIMMarkerPlacementOnLine",angleToLine:!0,relativeTo:"LineMiddle"},frame:{xmin:-10,ymin:-5,xmax:0,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[-12,-3.47],[-12,3.6],[1.96,-.03],[-12,-3.47]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:t}]}}]}]}}})}function Yr(e){let t="ESRI__ID",n=4;for(const r of e)if(r.name){if(r.name.toLowerCase()==="name"){t=r.name;break}r.name.toLowerCase().includes("name")?(t=r.name,n=2):r.fieldType==="esriFieldTypeString"&&n>3&&(t=r.name,n=3)}return t}function Zr(e,t,n){const r={color:[80,80,80],haloColor:[255,255,255],haloSize:.7,font:{size:10,weight:"normal"}},i=new de({labelExpressionInfo:new be({expression:n==="ESRI__ID"?`${t}`:`$feature.${n}`}),labelPlacement:"above-center",symbol:new ge(r)}),a=new de({labelExpressionInfo:new be({expression:`'${t}' + IIf($feature.ESRI__AggregationCount>1, ' (' + $feature.ESRI__AggregationCount + ')', '')`}),labelPlacement:"center-along",labelPosition:"parallel",repeatLabel:!1,symbol:new ge({...r,yoffset:"12px"})});return e==="entity"?[i]:[a]}function Kr(e,t,n){const r={color:[255,255,255],haloColor:[0,0,0],haloSize:.7,font:{size:10,weight:"bold"}},i=n==="ESRI__ID"?`${e}`:`$feature.${n}`;return t==="point"?[new de({labelExpressionInfo:new be({expression:i}),labelPlacement:"above-center",symbol:new ge(r)})]:t==="polyline"?[new de({labelExpressionInfo:new be({expression:i}),labelPlacement:"center-along",repeatLabel:!0,symbol:new ge(r)})]:t==="polygon"?[new de({labelExpressionInfo:new be({expression:i}),labelPlacement:"always-horizontal",symbol:new ge(r)})]:null}function Q(e){if(!e.json)return e;e.json.write=mt(e.json.write);const t=e.json.origins;if(!t)return e;let n;for(n in t){const r=t[n];r&&(r.write=mt(r.write))}return e}function mt(e){return typeof e=="object"&&e?(e.enabled!==!1&&(e.overridePolicy=Xr(e)),e):e===!0?me():e}function Xr(e){const{target:t,writer:n,overridePolicy:r,...i}=e;return function(a,o){const s=Et.call(this,a,o);return s.enabled?{...i,...s}:s}}function me(){return{overridePolicy:Et}}function Et(e,t){const n=!!this.geometryType;let r={enabled:n};return n&&(r={...r,...he.call(this,e,t)}),r}function he(e,t){return{ignoreOrigin:this.originIdOf(t)>Dt.DEFAULTS}}let b=class extends Br(Kt(nr(tr(Jt(ar(pr(lr(sr(Gt(Ht)))))))))){constructor(e){super(e),this.blendMode="normal",this.capabilities=Qt(!1,!0),this.charts=null,this.definitionExpression=null,this.displayField="",this.displayFilterEnabled=!0,this.displayFilterInfo=null,this.effect=null,this.elevationInfo=null,this.featureEffect=null,this.graphType=null,this.labelsVisible=!0,this.layerType=null,this.legendEnabled=!0,this.maxScale=0,this.minScale=0,this.objectIdField=Y,this.objectType=null,this.opacity=1,this.orderBy=null,this.parent=null,this.parentCompositeLayer=null,this.persistenceEnabled=!0,this.popupEnabled=!0,this.popupTemplate=null,this.refreshInterval=0,this.source={openPorts:()=>this.load().then(()=>{const t=new MessageChannel;return new Ut(t.port1,{channel:t,client:{queryFeatures:(n,r={})=>{const i=pe.fromJSON(n);return this.queryFeaturesJSON(i,r)}}}),[t.port2]})},this.type="knowledge-graph-sublayer",this.useViewTime=!0,this.visible=!0}get userHasUpdateItemPrivileges(){var e;return!!((e=this.parent)!=null&&e.userHasUpdateItemPrivileges)}get defaultPopupTemplate(){return this.createPopupTemplate()}set featureReduction(e){const t=this._normalizeFeatureReduction(e);this._set("featureReduction",t)}get fields(){var t,n;const e=[];return(n=(t=this.objectType)==null?void 0:t.properties)==null||n.forEach(r=>{const i=r.fieldType==="esriFieldTypeOID"?"esriFieldTypeInteger":r.fieldType;e.push(we.fromJSON({name:r.name,type:i,alias:r.alias,defaultValue:r.defaultValue,editable:r.editable,nullable:r.nullable}))}),e.push(we.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1}),we.fromJSON({name:Re,type:"esriFieldTypeInteger",alias:Re,editable:!1}),we.fromJSON({name:fe,type:"esriFieldTypeInteger",alias:fe,editable:!1})),e}get geometryType(){var n,r,i;if(((n=this.parentCompositeLayer)==null?void 0:n.type)==="link-chart")return this.graphType==="relationship"?"polyline":"point";const e=(i=this.parentCompositeLayer)==null?void 0:i.dataManager.geographicLookup.get((r=this.objectType)==null?void 0:r.name),t=e==null?void 0:e.geometryType;return t&&t!=="esriGeometryNull"?ye.fromJSON(t):null}get geometryFieldName(){var t,n,r;if(((t=this.parentCompositeLayer)==null?void 0:t.type)==="link-chart")return je;const e=(r=this.parentCompositeLayer)==null?void 0:r.dataManager.geographicLookup.get((n=this.objectType)==null?void 0:n.name);return(e==null?void 0:e.name)??null}get graphTypeName(){var e;return(e=this.objectType)==null?void 0:e.name}get hasM(){var r,i,a,o;const e=(i=this.parentCompositeLayer)==null?void 0:i.dataManager.geographicLookup.get((r=this.objectType)==null?void 0:r.name),t=e==null?void 0:e.name,n=t?(o=(a=this.objectType)==null?void 0:a.properties)==null?void 0:o[t]:null;return(n==null?void 0:n.hasM)??!1}get hasZ(){var r,i,a,o;const e=(i=this.parentCompositeLayer)==null?void 0:i.dataManager.geographicLookup.get((r=this.objectType)==null?void 0:r.name),t=e==null?void 0:e.name,n=t?(o=(a=this.objectType)==null?void 0:a.properties)==null?void 0:o[t]:null;return(n==null?void 0:n.hasZ)??!1}set labelingInfo(e){this._set("labelingInfo",e)}get labelingInfo(){if(this._isOverridden("labelingInfo"))return this._get("labelingInfo");if(!this.objectType||!this.parentCompositeLayer||!this.graphTypeName)return null;const e=this.objectType.properties?Yr(this.objectType.properties):"ESRI__ID";return this.parentCompositeLayer.type==="link-chart"?Zr(this.graphType,this.graphTypeName,e):Kr(this.graphTypeName,this.geometryType,e)}set renderer(e){At(e,this.fieldsIndex),this._set("renderer",e)}get renderer(){var i,a,o,s;if(this._isOverridden("renderer"))return this._get("renderer");const e=(o=(a=(i=this.parentCompositeLayer)==null?void 0:i.dataManager)==null?void 0:a.knowledgeGraph)==null?void 0:o.dataModel,t=[...(e==null?void 0:e.entityTypes)??[],...(e==null?void 0:e.relationshipTypes)??[]].map(l=>l.name).indexOf(this.graphTypeName),n=Wr(t);if(((s=this.parentCompositeLayer)==null?void 0:s.type)==="link-chart"){if(this.graphType==="relationship")return new gr({type:"simple",symbol:Jr(n)});const l=He(Ue(ye.toJSON("point")).renderer);return ze(l.symbol,n),l}const r=He(Ue(ye.toJSON(this.geometryType)).renderer);return ze(r.symbol,n),r}get spatialReference(){var e,t,n,r;return((r=(n=(t=(e=this.parentCompositeLayer)==null?void 0:e.dataManager)==null?void 0:t.knowledgeGraph)==null?void 0:n.dataModel)==null?void 0:r.spatialReference)??ht.WGS84}set timeInfo(e){this._set("timeInfo",e)}get title(){return this._isOverridden("title")?this._get("title"):this.graphTypeName}set title(e){this._set("title",e)}writeTitle(e,t){t.title=e??"Layer"}createPopupTemplate(e){return wr(this,e)}createQuery(){return new pe({where:"1=1",outFields:["*"]})}getField(e){return this.fieldsIndex.get(e)}getFieldDomain(e,t){return null}async queryFeatures(e,t){await this.load();const{resolvedQuery:n,queryEngine:r}=await this._setupQueryObjects(e),i=Tr.fromJSON(await r.executeQuery(n.toJSON(),t==null?void 0:t.signal));return i.features.forEach(a=>{a.sourceLayer=this}),i}async queryFeaturesJSON(e,t){await this.load();const{resolvedQuery:n,queryEngine:r}=await this._setupQueryObjects(e);return await r.executeQuery(n.toJSON(),t==null?void 0:t.signal)}async queryFeatureCount(e,t){await this.load();const{resolvedQuery:n,queryEngine:r}=await this._setupQueryObjects(e);return r.executeQueryForCount(n.toJSON(),t==null?void 0:t.signal)}async queryExtent(e={},t){var s,l,u,c;await this.load();const n={...e,returnGeometry:!0},{resolvedQuery:r,queryEngine:i}=await this._setupQueryObjects(n),a=await i.executeQueryForExtent(r.toJSON(),t==null?void 0:t.signal);let o;return o=((s=a.extent)==null?void 0:s.xmin)!=null&&((l=a.extent)==null?void 0:l.xmax)!=null&&((u=a.extent)==null?void 0:u.ymin)!=null&&((c=a.extent)==null?void 0:c.ymax)!=null?new Ee(a.extent):new Ee,{count:a.count,extent:o}}async queryObjectIds(e,t){await this.load();const n=pe.from(e);let r;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)r=this._cachedQueryEngine;else{const i=await this.parentCompositeLayer.dataManager.getData(n,this,t);r=this.loadQueryEngine(i)}return await r.executeQueryForIds(n.toJSON(),t==null?void 0:t.signal)}loadQueryEngine(e){var r;const t=new zt({geometryType:ye.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),n=new Bt({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:ye.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,featureIdInfo:{type:"object-id",fieldName:this.objectIdField},spatialReference:this.spatialReference.toJSON(),timeInfo:(r=this.timeInfo)==null?void 0:r.toJSON(),featureStore:t});return n.featureStore.addMany(e),n}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new pe({where:"1=1",outFields:[Y]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}load(e){return this.addResolvingPromise(this.parent.load(e).then(()=>xt(this.timeInfo,this.fieldsIndex))),Promise.resolve(this)}async _setupQueryObjects(e,t){var a;const n=pe.from(e),r=n.geometry;if(r&&!((a=r.spatialReference)!=null&&a.isWGS84)&&(await De(r.spatialReference,ie),n.geometry=Ie(r instanceof Tt||r instanceof St||r instanceof Mt?r:r.extent,ie)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)return{resolvedQuery:n,queryEngine:this._cachedQueryEngine};const i=await this.parentCompositeLayer.dataManager.getData(n,this,t);return{resolvedQuery:n,queryEngine:this.loadQueryEngine(i)}}};function en(e,t,n){var i,a;const r=[["ESRI__AGGREGATION_COUNT",Re],["ESRI__ORIGIN_ID",_e],["ESRI__DESTINATION_ID",Ne],["ESRI__LAYOUT_GEOMETRY",je]];try{for(const o of e)for(const[s,l]of r)o.labelExpression=(i=o.labelExpression)==null?void 0:i.replaceAll(s,l),(a=o.labelExpressionInfo)!=null&&a.expression&&(o.labelExpressionInfo.expression=o.labelExpressionInfo.expression.replaceAll(s,l))}catch(o){bt.getLogger(this).warn("Error updating labelingInfo",o)}return Wt(e,t,n)}h([f(Q(B(Yt)))],b.prototype,"blendMode",void 0),h([f()],b.prototype,"capabilities",void 0),h([f({readOnly:!0})],b.prototype,"userHasUpdateItemPrivileges",null),h([f({json:{origins:{"web-scene":{write:!1}},write:me()}})],b.prototype,"charts",void 0),h([f({readOnly:!0})],b.prototype,"defaultPopupTemplate",null),h([f({type:String,json:{origins:{service:{read:!1}},name:"layerDefinition.definitionExpression",write:{ignoreOrigin:!0}}})],b.prototype,"definitionExpression",void 0),h([f()],b.prototype,"displayField",void 0),h([f(Q(B(Xt)))],b.prototype,"displayFilterEnabled",void 0),h([f(Q(B(er)))],b.prototype,"displayFilterInfo",void 0),h([f(Q(B(Zt)))],b.prototype,"effect",void 0),h([f()],b.prototype,"elevationInfo",void 0),h([f(Q(B(rr)))],b.prototype,"featureEffect",void 0),h([f(Q(B(ir)))],b.prototype,"featureReduction",null),h([f()],b.prototype,"fields",null),h([f()],b.prototype,"geometryType",null),h([f()],b.prototype,"geometryFieldName",null),h([f({type:["entity","relationship"],nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],b.prototype,"graphType",void 0),h([f({type:String,nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],b.prototype,"graphTypeName",null),h([f()],b.prototype,"hasM",null),h([f()],b.prototype,"hasZ",null),h([f({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],b.prototype,"id",void 0),h([f({type:Boolean,value:!0,nonNullable:!0,json:{name:"showLabels",default:!1,write:{overridePolicy(){return{enabled:!!this.geometryType,alwaysWriteDefaults:!0,ignoreOrigin:!0}}}}})],b.prototype,"labelsVisible",void 0),h([f({type:[de],json:{name:"layerDefinition.drawingInfo.labelingInfo",read:en,write:me()}})],b.prototype,"labelingInfo",null),h([f({readOnly:!0,json:{read:!1,write:{writer(e,t){var n;switch((n=this.parentCompositeLayer)==null?void 0:n.type){case"link-chart":t.layerType="LinkChartSubLayer";break;case"knowledge-graph":t.layerType=this.geometryType?"KnowledgeGraphSubLayer":"KnowledgeGraphSubTable"}},isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],b.prototype,"layerType",void 0),h([f(Q(B(dr)))],b.prototype,"legendEnabled",void 0),h([f(Q(B(cr)))],b.prototype,"maxScale",void 0),h([f(Q(B(yr)))],b.prototype,"minScale",void 0),h([f()],b.prototype,"objectIdField",void 0),h([f()],b.prototype,"objectType",void 0),h([f(Q(B(mr)))],b.prototype,"opacity",void 0),h([f(Q(B(or)))],b.prototype,"orderBy",void 0),h([f({clonable:!1})],b.prototype,"parent",void 0),h([f()],b.prototype,"parentCompositeLayer",void 0),h([f(Q(B(hr)))],b.prototype,"popupEnabled",void 0),h([f({type:Pt,json:{name:"popupInfo",write:{ignoreOrigin:!0}}})],b.prototype,"popupTemplate",void 0),h([f({type:Number,json:{write:{overridePolicy:he}}})],b.prototype,"refreshInterval",void 0),h([f({types:br,json:{name:"layerDefinition.drawingInfo.renderer",write:me()}})],b.prototype,"renderer",null),h([f()],b.prototype,"source",void 0),h([f()],b.prototype,"spatialReference",null),h([f({type:fr,json:{name:"layerDefinition.timeInfo",write:{overridePolicy:he},origins:{"web-document":{name:"layerDefinition.timeInfo",read:!0,write:{overridePolicy:he}},"portal-item":{name:"layerDefinition.timeInfo",read:!0,write:{overridePolicy:he}}}}})],b.prototype,"timeInfo",null),h([f({type:String,json:{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],b.prototype,"title",null),h([vt("title")],b.prototype,"writeTitle",null),h([f({json:{read:!1}})],b.prototype,"type",void 0),h([f(Q(B(ur)))],b.prototype,"useViewTime",void 0),h([f({type:Boolean,json:{name:"visibility",write:me()}})],b.prototype,"visible",void 0),b=h([xe("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],b);export{nt as A,si as C,ii as D,J as E,b as I,at as P,ot as _,lt as a,it as b,st as c,Ye as d,ai as e,te as f,oi as g,ni as h,li as i,ri as m,Me as o,Ze as u,rt as v};
