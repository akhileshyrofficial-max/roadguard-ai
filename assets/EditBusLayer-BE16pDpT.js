const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/deleteForwardEdits-DOeKG6tm.js","assets/Identifiable-BjM0PfdN.js","assets/index-CVvIVqY1.js","assets/utils-C83x6Enz.js","assets/DeleteForwardEditsParameters-Z8d7YbVn.js"])))=>i.map(i=>d[i]);
import{H as U,c as V,m as T,d as k,n as f,aA as x,bJ as D}from"./Identifiable-BjM0PfdN.js";import{_ as A}from"./index-CVvIVqY1.js";import{o as P}from"./uuid-Cl5lrJ4c.js";const O=P(),H=new Map,S=new Map;async function C(e,r,d){if(!e||!d)return!1;if(!r)return!0;const n=new URL(e).host;let s=H.get(n);if(!s){const a=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");s=(await U(a,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return s===r}async function G(e,r,d=!1){var a,t,u;if(!e||!r)return!0;const n=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),s=(a=S.get(n))==null?void 0:a.entries();if(s){for(const[o,l]of s)if(l.name===r){const h=!((t=l.stack)!=null&&t.hasForwardEdits());if(!h&&d){const[{deleteForwardEdits:p},{default:m}]=await Promise.all([A(()=>import("./deleteForwardEdits-DOeKG6tm.js"),__vite__mapDeps([0,1,2,3])),A(()=>import("./DeleteForwardEditsParameters-Z8d7YbVn.js"),__vite__mapDeps([4,1,2]))]),b=await p(n,o,new m({sessionId:O,moment:l.moment}));return b.success&&((u=l.stack)==null||u.clearForwardEdits()),b.success}return h}}return!0}function W(e,r){var s;if(!e)return!1;const d=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),n=(s=S.get(d))==null?void 0:s.entries();if(n){for(const[a,t]of n)if(t.name===r)return t.lockType==="edit"}return!1}const y=new D.EventEmitter;function q(e){return y.on("apply-edits",new WeakRef(e))}function B(e){return y.on("update-moment",new WeakRef(e))}function K(e,r,d=null,n=!1){const s=x();return n=r==null||n,y.emit("apply-edits",{serviceUrl:e,layerId:r,gdbVersion:d,mayReceiveServiceEdits:n,result:s.promise}),s}const $=Symbol();function Q(e){return e!=null&&typeof e=="object"&&$ in e}function F(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function M(e,r,d){const n=new URL(e).host,s=H.get(n),a=t=>!t||t===s;return a(r)&&a(d)||r===d}const X=e=>{var n;var r;let d=(n=class extends e{constructor(...s){super(...s),this[r]=!0,this._applyEditsHandler=a=>{const{serviceUrl:t,layerId:u,gdbVersion:o,mayReceiveServiceEdits:l,result:h}=a,p=t===this.url,m=u!=null&&this.layerId!=null&&u===this.layerId,b=F(this),L=F(this)&&M(t,o,this.gdbVersion);if(!p||b&&!L||!m&&!l)return;const R=h.then(i=>{var _;if(this.lastEditsEventDate=new Date,m&&(i.addedFeatures.length||i.updatedFeatures.length||i.deletedFeatures.length||i.addedAttachments.length||i.updatedAttachments.length||i.deletedAttachments.length))return this.emit("edits",f(i)),i;const v=(_=i.editedFeatures)==null?void 0:_.find(({layerId:g})=>g===this.layerId);if(v){const{adds:g,updates:E,deletes:w}=v.editedFeatures,j={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:g?g.map(({attributes:c})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],deletedFeatures:w?w.map(({attributes:c})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],updatedFeatures:E?E.map(({current:{attributes:c}})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],editedFeatures:f(i.editedFeatures),exceededTransferLimit:!1,historicMoment:f(i.historicMoment)};return this.emit("edits",j),j}const I={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:f(i.editedFeatures),exceededTransferLimit:!1,historicMoment:f(i.historicMoment)};return"historicMoment"in this&&this._shouldUpdateHistoricMoment(t,o,I.historicMoment)&&this.emit("edits",I),I}).then(i=>("historicMoment"in this&&this._shouldUpdateHistoricMoment(t,o,i.historicMoment)&&(this.historicMoment=i.historicMoment),i));this.emit("apply-edits",{result:R})},this._updateMomentHandler=a=>{const{serviceUrl:t,gdbVersion:u,moment:o}=a,l=t===this.url,h=F(this),p=F(this)&&M(t,u,this.gdbVersion),m=F(this)&&!M(t,this.gdbVersion,null);l&&h&&p&&m&&"historicMoment"in this&&this.historicMoment!==o&&(this.historicMoment=o)},this.when().then(()=>{this.addHandles(q(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(B(this._updateMomentHandler))},()=>{})}_shouldUpdateHistoricMoment(s,a,t){return"historicMoment"in this&&this.historicMoment!==t&&W(s,a)}},r=$,n);return V([T()],d.prototype,"lastEditsEventDate",void 0),d=V([k("esri.layers.mixins.EditBusLayer")],d),d};export{X as F,W as a,K as c,G as i,C as o,Q as p,O as t};
