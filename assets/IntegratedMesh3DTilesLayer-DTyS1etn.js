import{cq as X,a6 as O,U as j,al as b,a3 as S,cl as w,c3 as x,bP as A,v as g,s as G,E as I,H as J,i as N,c as p,m as u,ac as P,d as W}from"./Identifiable-B58w9FD1.js";import{S as k}from"./MultiOriginJSONSupport-BZVrWF1x.js";import{v as q}from"./persistable-glrbGfu8.js";import{c as F,u as f,E as $,s as R,l as z,d as D,R as h}from"./vec32-BBi6eWk8.js";import{a as E}from"./projectionUtils-DsK_8mH5.js";import{h as H}from"./Layer-C63inyUN.js";import{i as K}from"./APIKeyMixin-BdBHvsIb.js";import{l as Z}from"./ArcGISService-81SDMnEP.js";import{e as B}from"./CustomParametersMixin-BzFiujo5.js";import{b as C,m as Q,y as Y}from"./OperationalLayer-CKgNO0NN.js";import{j as tt}from"./PortalLayer-BNHO2Fz3.js";import{t as et}from"./ScaleRangeLayer-Ci7jgVw5.js";import{n as V}from"./SceneModifications-Cl_KDoOK.js";import{$ as U,Z as it,w as ot}from"./elevationInfoUtils-BpDJq1uD.js";import"./index-VFfT8Aji.js";import"./MD5-C9MwAd2G.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./uuid-Cl5lrJ4c.js";import"./resourceExtension-CXue4rJ6.js";import"./common-DQOJ18NT.js";import"./layerContainerType-C5CzMsLd.js";import"./ElevationInfo-0ccmO6of.js";import"./fieldUtils-5LubkA3t.js";import"./lengthUtils-DEvA7X52.js";import"./asyncUtils-C5b0g4Vr.js";import"./layerUtils-CAMu1s-2.js";import"./PortalItem-DLsR4Y2a.js";import"./portalItemUtils-LGbTNR1x.js";let n=class extends Z(C(tt(et(k(B(K(H))))))){readModifications(e,l,a){this._modificationsSource={url:X(e,a),context:a}}initialize(){this.addHandles(O(()=>this.modifications,"after-changes",()=>this.modifications=this.modifications,j))}constructor(e){super(e),this.operationalLayerType="IntegratedMesh3DTilesLayer",this.modifications=null,this._modificationsSource=null,this.spatialReference=new b({wkid:4326,vcsWkid:115700}),this.fullExtent=new S(-180,-90,180,90,this.spatialReference),this.url=null,this.type="integrated-mesh-3dtiles",this.path=null,this.minScale=0,this.maxScale=0,this.rootTilesetJSON=null}set elevationInfo(e){e!=null&&e.mode!=="absolute-height"||this._set("elevationInfo",e),this._validateElevationInfo(e)}_verifyArray(e,l){if(!Array.isArray(e)||e.length<l)return!1;for(const a of e)if(typeof a!="number")return!1;return!0}_initFullExtent(){var y,M,L,T;const e=(M=(y=this.rootTilesetJSON)==null?void 0:y.root)==null?void 0:M.boundingVolume;if(!e)return;if(e.box){const i=e==null?void 0:e.box;if(i[3]>7645211&&i[7]>7645211&&i[11]>7645211)return}const l=(T=(L=this.rootTilesetJSON)==null?void 0:L.root)==null?void 0:T.transform,a=g();if(e.region&&this._verifyArray(e.region,6)){const i=e.region,m=w(i[0]),s=w(i[1]),o=i[4],r=w(i[2]),t=w(i[3]),c=i[5];this.fullExtent=new S({xmin:m,ymin:s,zmin:o,xmax:r,ymax:t,zmax:c,spatialReference:this.spatialReference})}else if(e.sphere&&this._verifyArray(e.sphere,4)){const i=e.sphere,m=x(i[0],i[1],i[2]),s=i[3]/Math.sqrt(3),o=g();F(o,m,x(s,s,s));const r=g();if(f(r,m,x(s,s,s)),l&&this._verifyArray(l,16)){const v=l;$(a,o,v),R(o,a),$(a,r,v),R(r,a)}E(o,A,0,o,b.WGS84,0),E(r,A,0,r,b.WGS84,0);const t=g(),c=g();z(t,o,r),D(c,o,r),this.fullExtent=new S({xmin:t[0],ymin:t[1],zmin:t[2],xmax:c[0],ymax:c[1],zmax:c[2],spatialReference:this.spatialReference})}else if(e.box&&this._verifyArray(e.box,12)){const i=e.box,m=x(i[0],i[1],i[2]),s=x(i[3],i[4],i[5]),o=x(i[6],i[7],i[8]),r=x(i[9],i[10],i[11]),t=[];for(let d=0;d<8;++d)t.push(g());if(f(t[0],m,s),f(t[0],t[0],o),f(t[0],t[0],r),h(t[1],m,s),f(t[1],t[1],o),f(t[1],t[1],r),f(t[2],m,s),h(t[2],t[2],o),f(t[2],t[2],r),h(t[3],m,s),h(t[3],t[3],o),f(t[3],t[3],r),f(t[4],m,s),f(t[4],t[4],o),h(t[4],t[4],r),h(t[5],m,s),f(t[5],t[5],o),h(t[5],t[5],r),f(t[6],m,s),h(t[6],t[6],o),h(t[6],t[6],r),h(t[7],m,s),h(t[7],t[7],o),h(t[7],t[7],r),l&&this._verifyArray(l,16)){const d=l;for(let _=0;_<8;++_)$(t[_],t[_],d)}const c=x(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),v=x(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);for(let d=0;d<8;++d)E(t[d],A,0,t[d],b.WGS84,0),z(v,v,t[d]),D(c,c,t[d]);this.fullExtent=new S({xmin:v[0],ymin:v[1],zmin:v[2],xmax:c[0],ymax:c[1],zmax:c[2],spatialReference:this.spatialReference})}}async load(e){return this.addResolvingPromise(this._doLoad(e)),this}async _doLoad(e){const l=e!=null?e.signal:null;try{await this.loadFromPortal({supportedTypes:["3DTiles Service"],validateItem:a=>{var y;if((y=a.typeKeywords)!=null&&y.includes("IntegratedMesh"))return!0;throw new G("portal:invalid-layer-item-type","Invalid layer item, expected '${expectedType}' ",{expectedType:"3DTiles Service containing IntegratedMesh"})}},e)}catch(a){I(a)}if(this._modificationsSource!=null){const a=await V.fromUrl(this._modificationsSource.url,this.spatialReference,e);this.setAtOrigin("modifications",a,this._modificationsSource.context.origin),this._modificationsSource=null}this.url&&await J(this.url,{query:{...this.customParameters,token:this.apiKey},responseType:"json",signal:l}).then(y=>{this.rootTilesetJSON=y.data,this._initFullExtent()},y=>{I(y)})}beforeSave(){if(this._modificationsSource!=null)return this.load().then(()=>{},()=>{})}async fetchAttributionData(){return this.load().then(()=>({}))}_validateElevationInfo(e){const l="Integrated mesh 3d tiles layers";U(N.getLogger(this),it(l,"absolute-height",e)),U(N.getLogger(this),ot(l,e))}};p([u({type:["IntegratedMesh3DTilesLayer"]})],n.prototype,"operationalLayerType",void 0),p([u({type:V,clonable:e=>e.clone()}),q({origins:["web-scene","portal-item"],type:"resource",prefix:"modifications"})],n.prototype,"modifications",void 0),p([P(["web-scene","portal-item"],"modifications")],n.prototype,"readModifications",null),p([u({type:b})],n.prototype,"spatialReference",void 0),p([u({type:S})],n.prototype,"fullExtent",void 0),p([u(Q)],n.prototype,"elevationInfo",null),p([u({type:["show","hide"]})],n.prototype,"listMode",void 0),p([u(Y)],n.prototype,"url",void 0),p([u({readOnly:!0})],n.prototype,"type",void 0),p([u({type:String,json:{origins:{"web-scene":{read:!0,write:!0},"portal-item":{read:!0,write:!0}},read:!1}})],n.prototype,"path",void 0),p([u({type:Number,json:{name:"layerDefinition.minScale",write:!0,origins:{service:{read:!1,write:!1}}}})],n.prototype,"minScale",void 0),p([u({type:Number,json:{name:"layerDefinition.maxScale",write:!0,origins:{service:{read:!1,write:!1}}}})],n.prototype,"maxScale",void 0),n=p([W("esri.layers.IntegratedMesh3DTilesLayer")],n);const Rt=n;export{Rt as default};
